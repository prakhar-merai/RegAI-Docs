<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Graph Nodes - Regulatory AI Docs</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../css/brands.min.css" rel="stylesheet">
        <link href="../../css/solid.min.css" rel="stylesheet">
        <link href="../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <link href="../../assets/_mkdocstrings.css" rel="stylesheet">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">Regulatory AI Docs</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item">
                                <a href="../.." class="nav-link">Home</a>
                            </li>
                            <li class="nav-item">
                                <a href="../../getting-started/" class="nav-link">Getting Started</a>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">API Reference</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../api/design_template/template_api/" class="dropdown-item">Design Template API</a>
</li>
                                    
<li>
    <a href="../../api/gspr_table/gspr_table_api/" class="dropdown-item">GSPR Table API</a>
</li>
                                    
<li>
    <a href="../../api/design_input/design_input/" class="dropdown-item">Design Input API</a>
</li>
                                    
<li>
    <a href="../../api/design_output/design_output/" class="dropdown-item">Design Output API</a>
</li>
                                    
<li>
    <a href="../../api/projects/projects_api/" class="dropdown-item">Projects API</a>
</li>
                                    
<li>
    <a href="../../api/session/session_api/" class="dropdown-item">Sessions API</a>
</li>
                                    
<li>
    <a href="../../api/other_api/other_api/" class="dropdown-item">Other APIs</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Database & Schemas</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../database_and_schemas/databases_overview/" class="dropdown-item">Databases Overview</a>
</li>
                                    
<li>
    <a href="../../database_and_schemas/schemas/" class="dropdown-item">APIs Response Schemas</a>
</li>
                                    
<li>
    <a href="../../database_and_schemas/other/" class="dropdown-item">Other</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle active" aria-current="page" role="button" data-bs-toggle="dropdown"  aria-expanded="false">AI Backend</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../chains_overview/" class="dropdown-item">Chains Overview</a>
</li>
                                    
<li>
    <a href="../agents/" class="dropdown-item">Workflows Overview</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active" aria-current="page">Graph Nodes</a>
</li>
                                    
<li>
    <a href="../output_models/" class="dropdown-item">Output Models</a>
</li>
                                    
<li>
    <a href="../prompts/" class="dropdown-item">Prompts</a>
</li>
                                    
<li>
    <a href="../others/" class="dropdown-item">Other Modules</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item">
                                <a href="../../faq/" class="nav-link">FAQ</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../agents/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../output_models/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#intelligent-regulatory-automation-nodes-core-system-modules" class="nav-link">üñ•Ô∏è Intelligent Regulatory Automation Nodes ‚Äî Core System Modules</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#component-recommender-node-suggest-device-subsystems" class="nav-link">üèóÔ∏è Component Recommender Node ‚Äî Suggest Device Subsystems</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#core.graph.nodes.component_recommender_node" class="nav-link">component_recommender_node</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#core.graph.nodes.component_recommender_node.component_recommender_node" class="nav-link">component_recommender_node</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#design-input-node-generate-detailed-design-requirements" class="nav-link">üìù Design Input Node ‚Äî Generate Detailed Design Requirements</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#core.graph.nodes.design_input_node" class="nav-link">design_input_node</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#core.graph.nodes.design_input_node.design_input_node" class="nav-link">design_input_node</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#design-output-node-compile-technical-specifications" class="nav-link">üìê Design Output Node ‚Äî Compile Technical Specifications</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#core.graph.nodes.design_output_node" class="nav-link">design_output_node</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#core.graph.nodes.design_output_node.design_output_node" class="nav-link">design_output_node</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#gspr-filter-node-refine-safety-performance-requirements" class="nav-link">üîÑ GSPR Filter Node ‚Äî Refine Safety &amp; Performance Requirements</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#core.graph.nodes.gspr_filter_node" class="nav-link">gspr_filter_node</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#core.graph.nodes.gspr_filter_node.gspr_filter_node" class="nav-link">gspr_filter_node</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#gspr-generator-node-create-safety-performance-tables" class="nav-link">üóÇÔ∏è GSPR Generator Node ‚Äî Create Safety &amp; Performance Tables</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#core.graph.nodes.gspr_generator_node" class="nav-link">gspr_generator_node</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#core.graph.nodes.gspr_generator_node.gspr_generator_node" class="nav-link">gspr_generator_node</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#gspr-table-generator-node-structure-compliance-evidence" class="nav-link">üìä GSPR Table Generator Node ‚Äî Structure Compliance Evidence</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#core.graph.nodes.gspr_table_generator_node" class="nav-link">gspr_table_generator_node</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#core.graph.nodes.gspr_table_generator_node.gspr_filter_node" class="nav-link">gspr_filter_node</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#core.graph.nodes.gspr_table_generator_node.gspr_table_generator_node" class="nav-link">gspr_table_generator_node</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#guard-node-validate-compliance-logic" class="nav-link">üõ°Ô∏è Guard Node ‚Äî Validate Compliance Logic</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#core.graph.nodes.guard_node" class="nav-link">guard_node</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#core.graph.nodes.guard_node.guard_node" class="nav-link">guard_node</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#intended-user-node-contextual-requirement-mapping" class="nav-link">üë§ Intended User Node ‚Äî Contextual Requirement Mapping</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#core.graph.nodes.intended_user_node" class="nav-link">intended_user_node</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#core.graph.nodes.intended_user_node.intended_user_node" class="nav-link">intended_user_node</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#risk-classification-node-determine-device-risk-class" class="nav-link">‚öñÔ∏è Risk Classification Node ‚Äî Determine Device Risk Class</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#core.graph.nodes.risk_classify_node" class="nav-link">risk_classify_node</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#core.graph.nodes.risk_classify_node.risk_classify_node" class="nav-link">risk_classify_node</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#full-gspr-orchestration-graph-end-to-end-flow" class="nav-link">üß© Full GSPR Orchestration Graph ‚Äî End-to-End Flow</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#core.graph.gspr_graph" class="nav-link">gspr_graph</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#core.graph.gspr_graph.GSPRGraph" class="nav-link">GSPRGraph</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#core.graph.gspr_graph.GSPRState" class="nav-link">GSPRState</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="intelligent-regulatory-automation-nodes-core-system-modules">üñ•Ô∏è Intelligent Regulatory Automation Nodes ‚Äî Core System Modules</h1>
<hr />
<h2 id="component-recommender-node-suggest-device-subsystems">üèóÔ∏è Component Recommender Node ‚Äî Suggest Device Subsystems</h2>
<p>Recommends appropriate <strong>components and subsystems</strong> for the device based on intended function and materials.
Optimizes design completeness and modular traceability.</p>


<div class="doc doc-object doc-module">



<a id="core.graph.nodes.component_recommender_node"></a>
    <div class="doc doc-contents first">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h2 id="core.graph.nodes.component_recommender_node.component_recommender_node" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">component_recommender_node</span><span class="p">(</span><span class="n">state</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Executes the component recommender chain, updates the state with
system-generated component suggestions under design_data.system_generated.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>state</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The current state of the system, containing device input and design data.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The updated state with recommended components added to system-generated design data.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>core/graph/nodes/component_recommender_node.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">component_recommender_node</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Executes the component recommender chain, updates the state with</span>
<span class="sd">    system-generated component suggestions under design_data.system_generated.</span>

<span class="sd">    Args:</span>
<span class="sd">        state (dict): The current state of the system, containing device input and design data.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: The updated state with recommended components added to system-generated design data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">device_input</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;device_input&quot;</span><span class="p">]</span>

    <span class="n">chain_input</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;medical_device&quot;</span><span class="p">:</span> <span class="n">device_input</span><span class="p">[</span><span class="s2">&quot;medical_device&quot;</span><span class="p">],</span>
        <span class="s2">&quot;intended_purpose&quot;</span><span class="p">:</span> <span class="n">device_input</span><span class="p">[</span><span class="s2">&quot;intended_purpose&quot;</span><span class="p">],</span>
        <span class="s2">&quot;device_type&quot;</span><span class="p">:</span> <span class="n">device_input</span><span class="p">[</span><span class="s2">&quot;device_type&quot;</span><span class="p">],</span>
        <span class="s2">&quot;material_type&quot;</span><span class="p">:</span> <span class="n">device_input</span><span class="p">[</span><span class="s2">&quot;material_type&quot;</span><span class="p">],</span>
    <span class="p">}</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Input to component recommender chain:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">chain_input</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">RunnableConfig</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;run_name&quot;</span><span class="p">:</span> <span class="s2">&quot;ComponentRecommender&quot;</span><span class="p">,</span>
        <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;LLM_APP&quot;</span><span class="p">,</span> <span class="s2">&quot;Component_Recommender&quot;</span><span class="p">,</span> <span class="s2">&quot;v1.0&quot;</span><span class="p">],</span>
        <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="s2">&quot;gpt-4o&quot;</span><span class="p">,</span>  <span class="c1"># or whichever LLM you‚Äôre using</span>
            <span class="s2">&quot;parser&quot;</span><span class="p">:</span> <span class="s2">&quot;PydanticOutputParser&quot;</span><span class="p">,</span>
            <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span>
            <span class="s2">&quot;max_tokens&quot;</span><span class="p">:</span> <span class="mi">1500</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span>

    <span class="c1"># Get fresh chain instance with current model selection</span>
    <span class="n">component_recommender_chain</span> <span class="o">=</span> <span class="n">get_component_recommender_chain</span><span class="p">()</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">component_recommender_chain</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">chain_input</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Raw LLM response: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Response must be a dict or Pydantic object with .dict() method.&quot;</span><span class="p">)</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">ComponentRecommenderModel</span><span class="p">(</span><span class="o">**</span><span class="n">response</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Recommended Components: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">components_list</span><span class="p">)</span>

    <span class="c1"># Update state with recommended components (ensuring uniqueness)</span>
    <span class="n">current_components</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;design_data&quot;</span><span class="p">][</span><span class="s2">&quot;system_generated&quot;</span><span class="p">][</span><span class="s2">&quot;components&quot;</span><span class="p">]</span>
    <span class="n">updated_components</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">current_components</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">components_list</span><span class="p">))</span>
    <span class="n">state</span><span class="p">[</span><span class="s2">&quot;design_data&quot;</span><span class="p">][</span><span class="s2">&quot;system_generated&quot;</span><span class="p">][</span><span class="s2">&quot;components&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">updated_components</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Updated system_generated components: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">updated_components</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">state</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><hr />
<h2 id="design-input-node-generate-detailed-design-requirements">üìù Design Input Node ‚Äî Generate Detailed Design Requirements</h2>
<p>Translates high-level specifications into <strong>detailed, regulatory-aligned design inputs</strong> for all subsystems.
Supports parallel processing for material, performance, and human factor requirements.</p>


<div class="doc doc-object doc-module">



<a id="core.graph.nodes.design_input_node"></a>
    <div class="doc doc-contents first">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h2 id="core.graph.nodes.design_input_node.design_input_node" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">design_input_node</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">component_name</span><span class="p">,</span> <span class="n">gspr_no</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Generates and updates the design input for a specific component and GSPR (General Safety and Performance Requirements).</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>state</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The current state of the system, containing user input and design data.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>component_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the component for which design input is generated.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>gspr_no</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The GSPR number associated with the design input.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The updated state with the generated design input added under the specified component and GSPR.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>core/graph/nodes/design_input_node.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">design_input_node</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">component_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">gspr_no</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates and updates the design input for a specific component and GSPR (General Safety and Performance Requirements).</span>

<span class="sd">    Args:</span>
<span class="sd">        state (dict): The current state of the system, containing user input and design data.</span>
<span class="sd">        component_name (str): The name of the component for which design input is generated.</span>
<span class="sd">        gspr_no (str): The GSPR number associated with the design input.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: The updated state with the generated design input added under the specified component and GSPR.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">user_input</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_input&quot;</span><span class="p">,</span> <span class="p">{})</span>

    <span class="n">device_meta</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;device_type&quot;</span><span class="p">:</span> <span class="n">user_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;device_type&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
        <span class="s2">&quot;intended_purpose&quot;</span><span class="p">:</span> <span class="n">user_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;intended_purpose&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
        <span class="s2">&quot;intended_users&quot;</span><span class="p">:</span> <span class="n">user_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;intended_users&quot;</span><span class="p">,</span> <span class="p">[]),</span>
        <span class="s2">&quot;risk_classification&quot;</span><span class="p">:</span> <span class="n">user_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;risk_classification&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Generating design input for component &#39;</span><span class="si">{</span><span class="n">component_name</span><span class="si">}</span><span class="s2">&#39; and GSPR &#39;</span><span class="si">{</span><span class="n">gspr_no</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
    <span class="p">)</span>

    <span class="n">item</span><span class="p">:</span> <span class="n">DesignInputModel</span> <span class="o">=</span> <span class="n">fetch_design_input</span><span class="p">(</span><span class="n">device_meta</span><span class="p">,</span> <span class="n">component_name</span><span class="p">,</span> <span class="n">gspr_no</span><span class="p">)</span>

    <span class="c1"># Ensure top-level design_input exists</span>
    <span class="k">if</span> <span class="s2">&quot;design_input&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">state</span><span class="p">:</span>
        <span class="n">state</span><span class="p">[</span><span class="s2">&quot;design_input&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Ensure component dict exists</span>
    <span class="k">if</span> <span class="n">component_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;design_input&quot;</span><span class="p">]:</span>
        <span class="n">state</span><span class="p">[</span><span class="s2">&quot;design_input&quot;</span><span class="p">][</span><span class="n">component_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Save GSPR entry under component</span>
    <span class="n">state</span><span class="p">[</span><span class="s2">&quot;design_input&quot;</span><span class="p">][</span><span class="n">component_name</span><span class="p">][</span><span class="n">gspr_no</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;component&quot;</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">component</span><span class="p">,</span>
        <span class="s2">&quot;requirement&quot;</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">requirement</span><span class="p">,</span>
        <span class="s2">&quot;gspr_text&quot;</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">gspr_text</span><span class="p">,</span>
        <span class="s2">&quot;standards&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="n">std</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">std</span><span class="p">,</span> <span class="s2">&quot;model_dump&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">std</span>
            <span class="k">for</span> <span class="n">std</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">standards</span>
        <span class="p">],</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">state</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><hr />
<h2 id="design-output-node-compile-technical-specifications">üìê Design Output Node ‚Äî Compile Technical Specifications</h2>
<p>Aggregates all <strong>design outputs</strong> including schematics, technical specifications, and implementation instructions.
Ensures each output maps back to input requirements for traceability.</p>


<div class="doc doc-object doc-module">



<a id="core.graph.nodes.design_output_node"></a>
    <div class="doc doc-contents first">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h2 id="core.graph.nodes.design_output_node.design_output_node" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">design_output_node</span><span class="p">(</span><span class="n">state</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">

        <p>Generate structured Design Output Reports for all components in the design_input section of the state.</p>
<p>This node automatically processes each component's design input using the
design output generation chain, which aligns with ISO/IEC standards and
GSPR requirements. No user input or PDF references are required ‚Äî all
context is derived from the internal design input data.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>state</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>State dictionary containing design input data.
Expected structure:
{
    "design_input": {
        "ComponentName": {
            "device_type": "...",
            "component": "...",
            "requirement": "...",
            "gspr_text": "...",
            "standards": [ ... ]
        },
        ...
    }
}</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dict[str, Any]: Updated state dictionary including generated design outputs.
Example:
{
    "design_output": {
        "ComponentName": "<Generated Report Text>"
    }
}</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>core/graph/nodes/design_output_node.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">design_output_node</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate structured Design Output Reports for all components in the design_input section of the state.</span>

<span class="sd">    This node automatically processes each component&#39;s design input using the</span>
<span class="sd">    design output generation chain, which aligns with ISO/IEC standards and</span>
<span class="sd">    GSPR requirements. No user input or PDF references are required ‚Äî all</span>
<span class="sd">    context is derived from the internal design input data.</span>

<span class="sd">    Args:</span>
<span class="sd">        state (Dict[str, Any]): State dictionary containing design input data.</span>
<span class="sd">            Expected structure:</span>
<span class="sd">            {</span>
<span class="sd">                &quot;design_input&quot;: {</span>
<span class="sd">                    &quot;ComponentName&quot;: {</span>
<span class="sd">                        &quot;device_type&quot;: &quot;...&quot;,</span>
<span class="sd">                        &quot;component&quot;: &quot;...&quot;,</span>
<span class="sd">                        &quot;requirement&quot;: &quot;...&quot;,</span>
<span class="sd">                        &quot;gspr_text&quot;: &quot;...&quot;,</span>
<span class="sd">                        &quot;standards&quot;: [ ... ]</span>
<span class="sd">                    },</span>
<span class="sd">                    ...</span>
<span class="sd">                }</span>
<span class="sd">            }</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dict[str, Any]: Updated state dictionary including generated design outputs.</span>
<span class="sd">            Example:</span>
<span class="sd">            {</span>
<span class="sd">                &quot;design_output&quot;: {</span>
<span class="sd">                    &quot;ComponentName&quot;: &quot;&lt;Generated Report Text&gt;&quot;</span>
<span class="sd">                }</span>
<span class="sd">            }</span>
<span class="sd">    &quot;&quot;&quot;</span> 

    <span class="n">design_inputs</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;design_input&quot;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">design_inputs</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;No design input found in state.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">state</span>

    <span class="c1"># Initialize design_output container</span>
    <span class="n">state</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;design_output&quot;</span><span class="p">,</span> <span class="p">{})</span>

    <span class="k">for</span> <span class="n">component</span><span class="p">,</span> <span class="n">component_input</span> <span class="ow">in</span> <span class="n">design_inputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generating Design Output Report for component &#39;</span><span class="si">{</span><span class="n">component</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Generate design output (auto ISO reference)</span>
            <span class="n">output_data</span> <span class="o">=</span> <span class="k">await</span> <span class="n">run_design_output_chain</span><span class="p">(</span>
                <span class="n">design_input</span><span class="o">=</span><span class="n">component_input</span><span class="p">,</span>
                <span class="n">component</span><span class="o">=</span><span class="n">component</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># Store in state</span>
            <span class="n">state</span><span class="p">[</span><span class="s2">&quot;design_output&quot;</span><span class="p">][</span><span class="n">component</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_data</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Design Output successfully generated for &#39;</span><span class="si">{</span><span class="n">component</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error generating Design Output for &#39;</span><span class="si">{</span><span class="n">component</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">state</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><hr />
<h2 id="gspr-filter-node-refine-safety-performance-requirements">üîÑ GSPR Filter Node ‚Äî Refine Safety &amp; Performance Requirements</h2>
<p>Filters and prioritizes GSPR clauses relevant to the device type, materials, and user environment.
Improves efficiency and reduces regulatory noise.</p>


<div class="doc doc-object doc-module">



<a id="core.graph.nodes.gspr_filter_node"></a>
    <div class="doc doc-contents first">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h2 id="core.graph.nodes.gspr_filter_node.gspr_filter_node" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">gspr_filter_node</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">component_name</span><span class="p">,</span> <span class="n">gspr_number</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Runs the GSPR filter chain for a specific component and GSPR number, and updates the session state
with the applicability and justification results.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>state</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The current session state containing user input and generated data.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>component_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the component being evaluated.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>gspr_number</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The GSPR number to filter and evaluate.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The updated session state with the GSPR filter results stored under <code>state['gspr_generated']</code>.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>core/graph/nodes/gspr_filter_node.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">gspr_filter_node</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">component_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">gspr_number</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Runs the GSPR filter chain for a specific component and GSPR number, and updates the session state</span>
<span class="sd">    with the applicability and justification results.</span>

<span class="sd">    Args:</span>
<span class="sd">        state (dict): The current session state containing user input and generated data.</span>
<span class="sd">        component_name (str): The name of the component being evaluated.</span>
<span class="sd">        gspr_number (str): The GSPR number to filter and evaluate.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: The updated session state with the GSPR filter results stored under `state[&#39;gspr_generated&#39;]`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">user_input</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_input&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user_input</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Missing &#39;user_input&#39; in state&quot;</span><span class="p">)</span>

    <span class="n">gspr_map</span> <span class="o">=</span> <span class="n">build_gspr_map</span><span class="p">()</span>

    <span class="c1"># Prepare input for the LLM chain</span>
    <span class="n">chain_input</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;medical_device&quot;</span><span class="p">:</span> <span class="n">user_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;medical_device&quot;</span><span class="p">),</span>
        <span class="s2">&quot;material_type&quot;</span><span class="p">:</span> <span class="n">user_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;material_type&quot;</span><span class="p">),</span>
        <span class="s2">&quot;device_type&quot;</span><span class="p">:</span> <span class="n">user_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;device_type&quot;</span><span class="p">),</span>
        <span class="s2">&quot;component_name&quot;</span><span class="p">:</span> <span class="n">component_name</span><span class="p">,</span>
        <span class="s2">&quot;intended_purpose&quot;</span><span class="p">:</span> <span class="n">user_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;intended_purpose&quot;</span><span class="p">),</span>
        <span class="s2">&quot;intended_users&quot;</span><span class="p">:</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">user_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;intended_users&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]),</span>
        <span class="s2">&quot;risk_classification&quot;</span><span class="p">:</span> <span class="n">user_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;risk_classification&quot;</span><span class="p">),</span>
        <span class="s2">&quot;gspr_number&quot;</span><span class="p">:</span> <span class="n">gspr_number</span><span class="p">,</span>
        <span class="s2">&quot;gspr_context&quot;</span><span class="p">:</span> <span class="n">gspr_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">gspr_number</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&lt;No GSPR found&gt;&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running GSPR filter for component: </span><span class="si">{</span><span class="n">component_name</span><span class="si">}</span><span class="s2">, GSPR </span><span class="si">{</span><span class="n">gspr_number</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Input to GSPR filter chain:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">chain_input</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>

    <span class="n">config</span><span class="p">:</span> <span class="n">RunnableConfig</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;run_name&quot;</span><span class="p">:</span> <span class="s2">&quot;GSPR_Filter&quot;</span><span class="p">,</span>
        <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;LLM_APP&quot;</span><span class="p">,</span> <span class="s2">&quot;GSPR_Filter&quot;</span><span class="p">,</span> <span class="s2">&quot;v1.0&quot;</span><span class="p">],</span>
        <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="s2">&quot;gpt-4o&quot;</span><span class="p">,</span>  <span class="c1"># replace with actual model</span>
            <span class="s2">&quot;parser&quot;</span><span class="p">:</span> <span class="s2">&quot;PydanticOutputParser&quot;</span><span class="p">,</span>
            <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span>  <span class="c1"># keep low for deterministic applicability</span>
            <span class="s2">&quot;max_tokens&quot;</span><span class="p">:</span> <span class="mi">1200</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span>
    <span class="c1"># ---------------- Run chain ----------------</span>
    <span class="n">response</span><span class="p">:</span> <span class="n">GSPRFilterResponse</span> <span class="o">=</span> <span class="n">gspr_filter_chain</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">chain_input</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;LLM structured response: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s2">&quot;json&quot;</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="p">))())</span>

    <span class="c1"># ---------------- Update state ----------------</span>
    <span class="n">gspr_generated</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;gspr_generated&quot;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">gspr_generated</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">component_name</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">gspr_generated</span><span class="p">[</span><span class="n">component_name</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">gspr_number</span><span class="p">,</span> <span class="p">{})</span>

    <span class="c1"># Only update the relevant fields under the nested structure.</span>
    <span class="c1"># Do not create separate top-level dicts.</span>
    <span class="n">gspr_generated</span><span class="p">[</span><span class="n">component_name</span><span class="p">][</span><span class="n">gspr_number</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;is_applicable&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">is_applicable</span><span class="p">),</span>
            <span class="s2">&quot;justification&quot;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">justification</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚úÖ Updated GSPR state for &#39;</span><span class="si">{</span><span class="n">component_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">gspr_number</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">is_applicable</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">state</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><hr />
<h2 id="gspr-generator-node-create-safety-performance-tables">üóÇÔ∏è GSPR Generator Node ‚Äî Create Safety &amp; Performance Tables</h2>
<p>Generates the initial <strong>GSPR table</strong> linking device features to regulatory clauses and compliance justifications.
Supports both FDA and MDR alignment.</p>


<div class="doc doc-object doc-module">



<a id="core.graph.nodes.gspr_generator_node"></a>
    <div class="doc doc-contents first">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h2 id="core.graph.nodes.gspr_generator_node.gspr_generator_node" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">gspr_generator_node</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">component_name</span><span class="p">,</span> <span class="n">main_gspr_number</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Runs the GSPR generator chain for a specific component and GSPR number, and updates the session state
with the generated requirements and standards.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>state</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The current session state containing user input and generated data.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>component_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the component for which the GSPR is being generated.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>main_gspr_number</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The main GSPR number associated with the generation process.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The updated session state with the GSPR generator results merged under <code>state['gspr_generated']</code>.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>core/graph/nodes/gspr_generator_node.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">gspr_generator_node</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">component_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">main_gspr_number</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Runs the GSPR generator chain for a specific component and GSPR number, and updates the session state</span>
<span class="sd">    with the generated requirements and standards.</span>

<span class="sd">    Args:</span>
<span class="sd">        state (dict): The current session state containing user input and generated data.</span>
<span class="sd">        component_name (str): The name of the component for which the GSPR is being generated.</span>
<span class="sd">        main_gspr_number (str): The main GSPR number associated with the generation process.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: The updated session state with the GSPR generator results merged under `state[&#39;gspr_generated&#39;]`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">user_input</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_input&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>

    <span class="n">chain_input</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;medical_device&quot;</span><span class="p">:</span> <span class="n">user_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;medical_device&quot;</span><span class="p">),</span>
        <span class="s2">&quot;material_type&quot;</span><span class="p">:</span> <span class="n">user_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;material_type&quot;</span><span class="p">),</span>
        <span class="s2">&quot;device_type&quot;</span><span class="p">:</span> <span class="n">user_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;device_type&quot;</span><span class="p">),</span>
        <span class="s2">&quot;intended_purpose&quot;</span><span class="p">:</span> <span class="n">user_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;intended_purpose&quot;</span><span class="p">),</span>
        <span class="s2">&quot;intended_users&quot;</span><span class="p">:</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">user_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;intended_users&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]),</span>
        <span class="s2">&quot;risk_classifications&quot;</span><span class="p">:</span> <span class="n">user_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;risk_classification&quot;</span><span class="p">),</span>
        <span class="s2">&quot;component&quot;</span><span class="p">:</span> <span class="n">component_name</span><span class="p">,</span>
        <span class="s2">&quot;gspr&quot;</span><span class="p">:</span> <span class="n">main_gspr_number</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generating GSPR for component: </span><span class="si">{</span><span class="n">component_name</span><span class="si">}</span><span class="s2">, GSPR: </span><span class="si">{</span><span class="n">main_gspr_number</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Input to GSPR Generator Chain: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">chain_input</span><span class="p">)</span>

    <span class="n">config</span><span class="p">:</span> <span class="n">RunnableConfig</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;run_name&quot;</span><span class="p">:</span> <span class="s2">&quot;GSPR_Generator&quot;</span><span class="p">,</span>
        <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;LLM_APP&quot;</span><span class="p">,</span> <span class="s2">&quot;GSPR_Generator&quot;</span><span class="p">,</span> <span class="s2">&quot;v1.0&quot;</span><span class="p">],</span>
        <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="s2">&quot;gpt-4o&quot;</span><span class="p">,</span>  <span class="c1"># replace with actual model in use</span>
            <span class="s2">&quot;parser&quot;</span><span class="p">:</span> <span class="s2">&quot;PydanticOutputParser&quot;</span><span class="p">,</span>
            <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span>  <span class="c1"># slightly higher than filter to allow some flexibility</span>
            <span class="s2">&quot;max_tokens&quot;</span><span class="p">:</span> <span class="mi">1500</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span>
    <span class="c1"># Get fresh chain instance with current model selection</span>
    <span class="n">gspr_generator_chain</span> <span class="o">=</span> <span class="n">get_gspr_generator_chain</span><span class="p">()</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">gspr_generator_chain</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">chain_input</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;üìù Raw LLM response: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>

    <span class="c1"># Normalize response</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">GSPRGeneratorModel</span><span class="p">(</span><span class="o">**</span><span class="n">response</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">GSPRGeneratorModel</span><span class="p">):</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">response</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">):</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">GSPRGeneratorModel</span><span class="p">(</span><span class="o">**</span><span class="n">response</span><span class="o">.</span><span class="n">dict</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expected dict or GSPRGeneratorModel, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">requirements</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">requirement</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
    <span class="n">standards</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">standard</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">standard</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">([</span><span class="n">item</span><span class="o">.</span><span class="n">standard</span><span class="p">]</span> <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">standard</span> <span class="k">else</span> <span class="p">[])</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚úÖ GSPR generated for &#39;</span><span class="si">{</span><span class="n">component_name</span><span class="si">}</span><span class="s2">&#39;, GSPR </span><span class="si">{</span><span class="n">main_gspr_number</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Requirements: </span><span class="si">%s</span><span class="s2"> | Standards: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">requirements</span><span class="p">,</span> <span class="n">standards</span><span class="p">)</span>

    <span class="c1"># ---------------- Update state ----------------</span>
    <span class="n">gspr_generated</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;gspr_generated&quot;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">gspr_generated</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">component_name</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">gspr_generated</span><span class="p">[</span><span class="n">component_name</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">main_gspr_number</span><span class="p">,</span> <span class="p">{})</span>

    <span class="c1"># Merge generator fields with whatever filter already stored.</span>
    <span class="n">gspr_generated</span><span class="p">[</span><span class="n">component_name</span><span class="p">][</span><span class="n">main_gspr_number</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;requirements&quot;</span><span class="p">:</span> <span class="n">requirements</span><span class="p">,</span>
            <span class="s2">&quot;standards&quot;</span><span class="p">:</span> <span class="n">standards</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">state</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><hr />
<h2 id="gspr-table-generator-node-structure-compliance-evidence">üìä GSPR Table Generator Node ‚Äî Structure Compliance Evidence</h2>
<p>Builds structured, <strong>audit-ready GSPR tables</strong> integrating standards, test evidence, and applicability notes.</p>


<div class="doc doc-object doc-module">



<a id="core.graph.nodes.gspr_table_generator_node"></a>
    <div class="doc doc-contents first">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h2 id="core.graph.nodes.gspr_table_generator_node.gspr_filter_node" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">gspr_filter_node</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">component_name</span><span class="p">,</span> <span class="n">gspr_number</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Run the GSPR filter chain for a given component and GSPR number,
then update the session state with applicability and justification.</p>
<p>All results are stored exclusively under <code>state['gspr_generated']</code>.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>core/graph/nodes/gspr_table_generator_node.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">gspr_filter_node</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">component_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">gspr_number</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run the GSPR filter chain for a given component and GSPR number,</span>
<span class="sd">    then update the session state with applicability and justification.</span>


<span class="sd">    All results are stored exclusively under `state[&#39;gspr_generated&#39;]`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">user_input</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_input&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user_input</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Missing &#39;user_input&#39; in state&quot;</span><span class="p">)</span>

    <span class="n">gspr_map</span> <span class="o">=</span> <span class="n">build_gspr_map</span><span class="p">()</span>

    <span class="c1"># Prepare input for the LLM chain</span>
    <span class="n">chain_input</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;medical_device&quot;</span><span class="p">:</span> <span class="n">user_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;medical_device&quot;</span><span class="p">),</span>
        <span class="s2">&quot;material_type&quot;</span><span class="p">:</span> <span class="n">user_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;material_type&quot;</span><span class="p">),</span>
        <span class="s2">&quot;device_type&quot;</span><span class="p">:</span> <span class="n">user_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;device_type&quot;</span><span class="p">),</span>
        <span class="s2">&quot;component_name&quot;</span><span class="p">:</span> <span class="n">component_name</span><span class="p">,</span>
        <span class="s2">&quot;intended_purpose&quot;</span><span class="p">:</span> <span class="n">user_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;intended_purpose&quot;</span><span class="p">),</span>
        <span class="s2">&quot;intended_users&quot;</span><span class="p">:</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">user_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;intended_users&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]),</span>
        <span class="s2">&quot;risk_classification&quot;</span><span class="p">:</span> <span class="n">user_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;risk_classification&quot;</span><span class="p">),</span>
        <span class="s2">&quot;gspr_number&quot;</span><span class="p">:</span> <span class="n">gspr_number</span><span class="p">,</span>
        <span class="s2">&quot;gspr_context&quot;</span><span class="p">:</span> <span class="n">gspr_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">gspr_number</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&lt;No GSPR found&gt;&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running GSPR filter for component: </span><span class="si">{</span><span class="n">component_name</span><span class="si">}</span><span class="s2">, GSPR </span><span class="si">{</span><span class="n">gspr_number</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Input to GSPR filter chain:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">chain_input</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>

    <span class="n">config</span><span class="p">:</span> <span class="n">RunnableConfig</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;run_name&quot;</span><span class="p">:</span> <span class="s2">&quot;GSPR_Filter&quot;</span><span class="p">,</span>
        <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;LLM_APP&quot;</span><span class="p">,</span> <span class="s2">&quot;GSPR_Filter&quot;</span><span class="p">,</span> <span class="s2">&quot;v1.0&quot;</span><span class="p">],</span>
        <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="s2">&quot;gpt-4o&quot;</span><span class="p">,</span>  <span class="c1"># replace with actual model</span>
            <span class="s2">&quot;parser&quot;</span><span class="p">:</span> <span class="s2">&quot;PydanticOutputParser&quot;</span><span class="p">,</span>
            <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span>  <span class="c1"># keep low for deterministic applicability</span>
            <span class="s2">&quot;max_tokens&quot;</span><span class="p">:</span> <span class="mi">1200</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span>
    <span class="c1"># ---------------- Run chain ----------------</span>
    <span class="n">response</span><span class="p">:</span> <span class="n">GSPRFilterResponse</span> <span class="o">=</span> <span class="n">gspr_filter_chain</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">chain_input</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;LLM structured response: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s2">&quot;json&quot;</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="p">))())</span>

    <span class="c1"># ---------------- Update state ----------------</span>
    <span class="n">gspr_generated</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;gspr_generated&quot;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">gspr_generated</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">component_name</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">gspr_generated</span><span class="p">[</span><span class="n">component_name</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">gspr_number</span><span class="p">,</span> <span class="p">{})</span>

    <span class="c1"># Only update the relevant fields under the nested structure.</span>
    <span class="c1"># Do not create separate top-level dicts.</span>
    <span class="n">gspr_generated</span><span class="p">[</span><span class="n">component_name</span><span class="p">][</span><span class="n">gspr_number</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;is_applicable&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">is_applicable</span><span class="p">),</span>
            <span class="s2">&quot;justification&quot;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">justification</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚úÖ Updated GSPR state for &#39;</span><span class="si">{</span><span class="n">component_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">gspr_number</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">is_applicable</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">state</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="core.graph.nodes.gspr_table_generator_node.gspr_table_generator_node" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">gspr_table_generator_node</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">component_name</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Generates applicability and justifications for all 181 GSPR sections for a given component.
Updates the session state with the results and returns a summarized table list.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>state</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The current session state containing user input and generated data.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>component_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the component for which the GSPR table is generated.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>tuple[dict, list[dict]]: A tuple containing the updated session state and a list of dictionaries</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="list">list</span>[<span title="dict">dict</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>summarizing the GSPR table data.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>core/graph/nodes/gspr_table_generator_node.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">gspr_table_generator_node</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">component_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates applicability and justifications for all 181 GSPR sections for a given component.</span>
<span class="sd">    Updates the session state with the results and returns a summarized table list.</span>

<span class="sd">    Args:</span>
<span class="sd">        state (dict): The current session state containing user input and generated data.</span>
<span class="sd">        component_name (str): The name of the component for which the GSPR table is generated.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple[dict, list[dict]]: A tuple containing the updated session state and a list of dictionaries</span>
<span class="sd">        summarizing the GSPR table data.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">user_input</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_input&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user_input</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Missing &#39;user_input&#39; in state&quot;</span><span class="p">)</span>

    <span class="n">gspr_map</span> <span class="o">=</span> <span class="n">build_gspr_map</span><span class="p">()</span>
    <span class="n">gspr_generated</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;gspr_generated&quot;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">gspr_generated</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">component_name</span><span class="p">,</span> <span class="p">{})</span>

    <span class="n">table_data</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">config</span><span class="p">:</span> <span class="n">RunnableConfig</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;run_name&quot;</span><span class="p">:</span> <span class="s2">&quot;GSPR_Table_Generation&quot;</span><span class="p">,</span>
        <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;LLM_APP&quot;</span><span class="p">,</span> <span class="s2">&quot;GSPR_Table&quot;</span><span class="p">,</span> <span class="s2">&quot;v1.0&quot;</span><span class="p">],</span>
        <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="s2">&quot;gpt-4o&quot;</span><span class="p">,</span>  <span class="c1"># replace if needed</span>
            <span class="s2">&quot;parser&quot;</span><span class="p">:</span> <span class="s2">&quot;PydanticOutputParser&quot;</span><span class="p">,</span>
            <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span>
            <span class="s2">&quot;max_tokens&quot;</span><span class="p">:</span> <span class="mi">1200</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;üîÑ Starting GSPR Table Generation for component: </span><span class="si">{</span><span class="n">component_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Iterate through all 181 GSPRs</span>
    <span class="k">for</span> <span class="n">gspr_no</span><span class="p">,</span> <span class="n">gspr_context</span> <span class="ow">in</span> <span class="n">gspr_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">chain_input</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;medical_device&quot;</span><span class="p">:</span> <span class="n">user_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;medical_device&quot;</span><span class="p">),</span>
            <span class="s2">&quot;material_type&quot;</span><span class="p">:</span> <span class="n">user_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;material_type&quot;</span><span class="p">),</span>
            <span class="s2">&quot;device_type&quot;</span><span class="p">:</span> <span class="n">user_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;device_type&quot;</span><span class="p">),</span>
            <span class="s2">&quot;component_name&quot;</span><span class="p">:</span> <span class="n">component_name</span><span class="p">,</span>
            <span class="s2">&quot;intended_purpose&quot;</span><span class="p">:</span> <span class="n">user_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;intended_purpose&quot;</span><span class="p">),</span>
            <span class="s2">&quot;intended_users&quot;</span><span class="p">:</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">user_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;intended_users&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]),</span>
            <span class="s2">&quot;risk_classification&quot;</span><span class="p">:</span> <span class="n">user_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;risk_classification&quot;</span><span class="p">),</span>
            <span class="s2">&quot;gspr_number&quot;</span><span class="p">:</span> <span class="n">gspr_no</span><span class="p">,</span>
            <span class="s2">&quot;gspr_context&quot;</span><span class="p">:</span> <span class="n">gspr_context</span> <span class="ow">or</span> <span class="s2">&quot;&lt;No GSPR found&gt;&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running GSPR </span><span class="si">{</span><span class="n">gspr_no</span><span class="si">}</span><span class="s2"> for component </span><span class="si">{</span><span class="n">component_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">response</span><span class="p">:</span> <span class="n">GSPRFilterResponse</span> <span class="o">=</span> <span class="n">gspr_filter_chain</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">chain_input</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>

        <span class="c1"># Save result in session state</span>
        <span class="n">gspr_generated</span><span class="p">[</span><span class="n">component_name</span><span class="p">][</span><span class="n">gspr_no</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;is_applicable&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">is_applicable</span><span class="p">),</span>
            <span class="s2">&quot;justification&quot;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">justification</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># Build response table entry</span>
        <span class="n">table_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;section_number&quot;</span><span class="p">:</span> <span class="n">gspr_no</span><span class="p">,</span>
                <span class="s2">&quot;section_name&quot;</span><span class="p">:</span> <span class="n">gspr_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gspr_context</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;&lt;No title&gt;&quot;</span><span class="p">,</span>
                <span class="s2">&quot;applicable&quot;</span><span class="p">:</span> <span class="s2">&quot;Y&quot;</span> <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">is_applicable</span> <span class="k">else</span> <span class="s2">&quot;N&quot;</span><span class="p">,</span>
                <span class="s2">&quot;justification&quot;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">justification</span> <span class="ow">or</span> <span class="s2">&quot;No justification provided&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚úÖ Completed GSPR table generation for </span><span class="si">{</span><span class="n">component_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">state</span><span class="p">,</span> <span class="n">table_data</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><hr />
<h2 id="guard-node-validate-compliance-logic">üõ°Ô∏è Guard Node ‚Äî Validate Compliance Logic</h2>
<p>Enforces regulatory rules across the workflow.
Prevents unsafe or inconsistent data propagation and validates each node's output.</p>


<div class="doc doc-object doc-module">



<a id="core.graph.nodes.guard_node"></a>
    <div class="doc doc-contents first">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h2 id="core.graph.nodes.guard_node.guard_node" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">guard_node</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">cat</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Executes the regulatory guard agent to process the given text and category, returning the AI-generated response.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>text</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The input text to be processed by the regulatory guard agent.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>cat</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The category associated with the input text.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>str</code></td>            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The content of the AI-generated response.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>core/graph/nodes/guard_node.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">guard_node</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">cat</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Executes the regulatory guard agent to process the given text and category, returning the AI-generated response.</span>

<span class="sd">    Args:</span>
<span class="sd">        text (str): The input text to be processed by the regulatory guard agent.</span>
<span class="sd">        cat (str): The category associated with the input text.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: The content of the AI-generated response.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Prepare messages in LangChain-native format</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">SystemMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">system_instructions</span><span class="p">),</span>
        <span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Category: </span><span class="si">{</span><span class="n">cat</span><span class="si">}</span><span class="se">\n\n</span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="n">chain_input</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="n">messages</span><span class="p">}</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Input to regulatory_guard_agent_node:&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">chain_input</span><span class="p">)</span>

    <span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;run_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Regulatory_Guard_Agent_Node&quot;</span><span class="p">,</span>
        <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;LLM_APP&quot;</span><span class="p">,</span> <span class="s2">&quot;Regulatory_Agent&quot;</span><span class="p">,</span> <span class="s2">&quot;v1.0&quot;</span><span class="p">],</span>
        <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="s2">&quot;gpt-4o&quot;</span><span class="p">,</span>
            <span class="s2">&quot;purpose&quot;</span><span class="p">:</span> <span class="s2">&quot;regulatory_guard&quot;</span><span class="p">,</span>
            <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span>
            <span class="s2">&quot;max_tokens&quot;</span><span class="p">:</span> <span class="mi">800</span><span class="p">,</span>
            <span class="s2">&quot;category&quot;</span><span class="p">:</span> <span class="n">cat</span>
        <span class="p">},</span>
    <span class="p">}</span>

    <span class="c1"># Get fresh agent instance with current model selection</span>
    <span class="n">regulatory_guard_agent</span> <span class="o">=</span> <span class="n">get_regulatory_guard_agent</span><span class="p">()</span>
    <span class="c1"># Execute agent</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">regulatory_guard_agent</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">chain_input</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Guard Node Result (raw):&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="c1"># ---------------------------------------------</span>
    <span class="c1"># Extract ONLY the AIMessage content</span>
    <span class="c1"># ---------------------------------------------</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;messages&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;messages&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">AIMessage</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;AIMessage content:&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">msg</span><span class="o">.</span><span class="n">content</span>  <span class="c1"># &lt;-- return ONLY model output</span>

    <span class="c1"># Fallbacks if agent returns simpler structures</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">AIMessage</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">content</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;content&quot;</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">]</span>

    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><hr />
<h2 id="intended-user-node-contextual-requirement-mapping">üë§ Intended User Node ‚Äî Contextual Requirement Mapping</h2>
<p>Incorporates <strong>user environment and use-case context</strong> into design inputs and risk analysis.</p>


<div class="doc doc-object doc-module">



<a id="core.graph.nodes.intended_user_node"></a>
    <div class="doc doc-contents first">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h2 id="core.graph.nodes.intended_user_node.intended_user_node" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">intended_user_node</span><span class="p">(</span><span class="n">state</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Executes the LLM-driven intended user identification chain and updates the state
with the identified intended users under <code>design_data.system_generated.intended_users</code>.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>state</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The current state of the system, containing device input and design data.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The updated state with the identified intended users added to the system-generated design data.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>core/graph/nodes/intended_user_node.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">intended_user_node</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Executes the LLM-driven intended user identification chain and updates the state</span>
<span class="sd">    with the identified intended users under `design_data.system_generated.intended_users`.</span>

<span class="sd">    Args:</span>
<span class="sd">        state (dict): The current state of the system, containing device input and design data.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: The updated state with the identified intended users added to the system-generated design data.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># --------------------------------</span>
    <span class="c1"># Prepare input for the LLM chain</span>
    <span class="c1"># --------------------------------</span>
    <span class="n">device_input</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;device_input&quot;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">design_data</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;design_data&quot;</span><span class="p">,</span> <span class="p">{})</span>

    <span class="n">system_generated</span> <span class="o">=</span> <span class="n">design_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;system_generated&quot;</span><span class="p">,</span> <span class="p">{})</span>

    <span class="n">chain_input</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;medical_device&quot;</span><span class="p">:</span> <span class="n">device_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;medical_device&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
        <span class="s2">&quot;material_type&quot;</span><span class="p">:</span> <span class="n">device_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;material_type&quot;</span><span class="p">,</span> <span class="p">[]),</span>
        <span class="s2">&quot;device_type&quot;</span><span class="p">:</span> <span class="n">device_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;device_type&quot;</span><span class="p">,</span> <span class="p">[]),</span>
        <span class="s2">&quot;intended_purpose&quot;</span><span class="p">:</span> <span class="n">device_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;intended_purpose&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
        <span class="s2">&quot;components&quot;</span><span class="p">:</span> <span class="n">system_generated</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;components&quot;</span><span class="p">,</span> <span class="p">[]),</span>
        <span class="s2">&quot;risk_classification&quot;</span><span class="p">:</span> <span class="n">system_generated</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;risk_classification&quot;</span><span class="p">,</span> <span class="p">{}),</span>
    <span class="p">}</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Input to intended user chain:&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">chain_input</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>

    <span class="c1"># --------------------------------</span>
    <span class="c1"># Configure and invoke the chain</span>
    <span class="c1"># --------------------------------</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">RunnableConfig</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;run_name&quot;</span><span class="p">:</span> <span class="s2">&quot;IntendedUser&quot;</span><span class="p">,</span>
        <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;LLM_APP&quot;</span><span class="p">,</span> <span class="s2">&quot;Intended_User&quot;</span><span class="p">,</span> <span class="s2">&quot;v1.0&quot;</span><span class="p">],</span>
        <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="s2">&quot;gpt-4o&quot;</span><span class="p">,</span>
            <span class="s2">&quot;parser&quot;</span><span class="p">:</span> <span class="s2">&quot;PydanticOutputParser&quot;</span><span class="p">,</span>
            <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span>
            <span class="s2">&quot;max_tokens&quot;</span><span class="p">:</span> <span class="mi">800</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span>

    <span class="c1"># Get fresh chain instance with current model selection</span>
    <span class="n">intended_user_chain</span> <span class="o">=</span> <span class="n">get_intended_user_chain</span><span class="p">()</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">intended_user_chain</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">chain_input</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Raw LLM response: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>

    <span class="c1"># --------------------------------</span>
    <span class="c1"># Normalize response</span>
    <span class="c1"># --------------------------------</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Expected response to be a dict or BaseModel.&quot;</span><span class="p">)</span>

    <span class="n">intended_users</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;intended_users&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">intended_users</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;intended_users&#39; should be a list in the response.&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Identified Intended Users: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">intended_users</span><span class="p">)</span>

    <span class="c1"># --------------------------------</span>
    <span class="c1"># Update system_generated intended users</span>
    <span class="c1"># --------------------------------</span>
    <span class="n">state</span><span class="p">[</span><span class="s2">&quot;design_data&quot;</span><span class="p">][</span><span class="s2">&quot;system_generated&quot;</span><span class="p">][</span><span class="s2">&quot;intended_users&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">intended_users</span><span class="p">))</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;‚úÖ Updated system_generated with intended users:&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;design_data&quot;</span><span class="p">][</span><span class="s2">&quot;system_generated&quot;</span><span class="p">][</span><span class="s2">&quot;intended_users&quot;</span><span class="p">],</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">state</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><hr />
<h2 id="risk-classification-node-determine-device-risk-class">‚öñÔ∏è Risk Classification Node ‚Äî Determine Device Risk Class</h2>
<p>Classifies device according to FDA and MDR risk frameworks.
Directly informs GSPR applicability and design control measures.</p>


<div class="doc doc-object doc-module">



<a id="core.graph.nodes.risk_classify_node"></a>
    <div class="doc doc-contents first">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h2 id="core.graph.nodes.risk_classify_node.risk_classify_node" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">risk_classify_node</span><span class="p">(</span><span class="n">state</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Executes the LLM-driven risk classification chain and updates the state
with the generated risk classification under <code>design_data.system_generated.risk_classification</code>.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>state</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The current state of the system, containing device input and design data.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The updated state with the generated risk classification added to the system-generated design data.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>core/graph/nodes/risk_classify_node.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">risk_classify_node</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Executes the LLM-driven risk classification chain and updates the state</span>
<span class="sd">    with the generated risk classification under `design_data.system_generated.risk_classification`.</span>

<span class="sd">    Args:</span>
<span class="sd">        state (dict): The current state of the system, containing device input and design data.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: The updated state with the generated risk classification added to the system-generated design data.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># --------------------------------</span>
    <span class="c1"># Prepare chain input</span>
    <span class="c1"># --------------------------------</span>
    <span class="n">device_input</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;device_input&quot;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">design_data</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;design_data&quot;</span><span class="p">,</span> <span class="p">{})</span>

    <span class="n">chain_input</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;medical_device&quot;</span><span class="p">:</span> <span class="n">device_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;medical_device&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
        <span class="s2">&quot;material_type&quot;</span><span class="p">:</span> <span class="n">device_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;material_type&quot;</span><span class="p">,</span> <span class="p">[]),</span>
        <span class="s2">&quot;device_type&quot;</span><span class="p">:</span> <span class="n">device_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;device_type&quot;</span><span class="p">,</span> <span class="p">[]),</span>
        <span class="s2">&quot;intended_purpose&quot;</span><span class="p">:</span> <span class="n">device_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;intended_purpose&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
        <span class="s2">&quot;components&quot;</span><span class="p">:</span> <span class="n">design_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;system_generated&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;components&quot;</span><span class="p">,</span> <span class="p">[]),</span>
    <span class="p">}</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Input to risk classification chain:&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">chain_input</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>

    <span class="c1"># --------------------------------</span>
    <span class="c1"># Configure chain execution</span>
    <span class="c1"># --------------------------------</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">RunnableConfig</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;run_name&quot;</span><span class="p">:</span> <span class="s2">&quot;RiskClassification&quot;</span><span class="p">,</span>
        <span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;LLM_APP&quot;</span><span class="p">,</span> <span class="s2">&quot;Risk_Classification&quot;</span><span class="p">,</span> <span class="s2">&quot;v1.0&quot;</span><span class="p">],</span>
        <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="s2">&quot;gpt-4o&quot;</span><span class="p">,</span>
            <span class="s2">&quot;parser&quot;</span><span class="p">:</span> <span class="s2">&quot;PydanticOutputParser&quot;</span><span class="p">,</span>
            <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span>
            <span class="s2">&quot;max_tokens&quot;</span><span class="p">:</span> <span class="mi">800</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span>

    <span class="c1"># --------------------------------</span>
    <span class="c1"># Run LLM chain</span>
    <span class="c1"># --------------------------------</span>
    <span class="c1"># Get fresh chain instance with current model selection</span>
    <span class="n">risk_classification_chain</span> <span class="o">=</span> <span class="n">get_risk_classification_chain</span><span class="p">()</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">risk_classification_chain</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">chain_input</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Raw LLM response: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Response must be a dict or a Pydantic object with .model_dump().&quot;</span><span class="p">)</span>

    <span class="n">risk_classification</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;risk_classification&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">risk_classification</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid or missing &#39;risk_classification&#39; in response.&quot;</span><span class="p">)</span>

    <span class="c1"># --------------------------------</span>
    <span class="c1"># Update system_generated risk classification</span>
    <span class="c1"># --------------------------------</span>
    <span class="n">state</span><span class="p">[</span><span class="s2">&quot;design_data&quot;</span><span class="p">][</span><span class="s2">&quot;system_generated&quot;</span><span class="p">][</span><span class="s2">&quot;risk_classification&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">risk_classification</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Updated system_generated with risk classification:&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;design_data&quot;</span><span class="p">][</span><span class="s2">&quot;system_generated&quot;</span><span class="p">][</span><span class="s2">&quot;risk_classification&quot;</span><span class="p">],</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">state</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><hr />
<h2 id="full-gspr-orchestration-graph-end-to-end-flow">üß© Full GSPR Orchestration Graph ‚Äî End-to-End Flow</h2>
<p>Visualizes the <strong>complete multi-agent workflow</strong>, showing input processing, template generation, and compliance outputs.</p>


<div class="doc doc-object doc-module">



<a id="core.graph.gspr_graph"></a>
    <div class="doc doc-contents first">










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="core.graph.gspr_graph.GSPRGraph" class="doc doc-heading">
            <code>GSPRGraph</code>


</h2>


    <div class="doc doc-contents ">



        <p>LangGraph-based workflow for GSPR generation.</p>
<p>This class orchestrates the GSPR generation process using LangGraph nodes.
Each node determines its own adaptive LLM temperature using the GSPRChain
and performs specific tasks such as context building, section grouping, and
group processing.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="core.graph.gspr_graph.GSPRGraph.chain">chain</span></code></td>
            <td>
                  <code><span title="regulatory.core.chains.gspr_chain.GSPRChain">GSPRChain</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The chain instance used for GSPR generation.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="core.graph.gspr_graph.GSPRGraph.base_context">base_context</span></code></td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The base context shared across nodes.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="core.graph.gspr_graph.GSPRGraph.concurrency_limit">concurrency_limit</span></code></td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The maximum number of concurrent tasks.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="core.graph.gspr_graph.GSPRGraph.memory">memory</span></code></td>
            <td>
                  <code><span title="langgraph.checkpoint.memory.InMemorySaver">InMemorySaver</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The in-memory saver for graph checkpoints.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="core.graph.gspr_graph.GSPRGraph.graph">graph</span></code></td>
            <td>
                  <code><span title="langgraph.graph.StateGraph">StateGraph</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The compiled LangGraph instance.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="core.graph.gspr_graph.GSPRGraph.component_name">component_name</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the component being processed.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="core.graph.gspr_graph.GSPRGraph.session_id">session_id</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The session identifier for the current run.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="core.graph.gspr_graph.GSPRGraph.job_id">job_id</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The job identifier for tracking progress.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="core.graph.gspr_graph.GSPRGraph.requirement_sections">requirement_sections</span></code></td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The requirement sections to process.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>core/graph/gspr_graph.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">GSPRGraph</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    LangGraph-based workflow for GSPR generation.</span>

<span class="sd">    This class orchestrates the GSPR generation process using LangGraph nodes.</span>
<span class="sd">    Each node determines its own adaptive LLM temperature using the GSPRChain</span>
<span class="sd">    and performs specific tasks such as context building, section grouping, and</span>
<span class="sd">    group processing.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        chain (GSPRChain): The chain instance used for GSPR generation.</span>
<span class="sd">        base_context (dict): The base context shared across nodes.</span>
<span class="sd">        concurrency_limit (int): The maximum number of concurrent tasks.</span>
<span class="sd">        memory (InMemorySaver): The in-memory saver for graph checkpoints.</span>
<span class="sd">        graph (StateGraph): The compiled LangGraph instance.</span>
<span class="sd">        component_name (str): The name of the component being processed.</span>
<span class="sd">        session_id (str): The session identifier for the current run.</span>
<span class="sd">        job_id (str): The job identifier for tracking progress.</span>
<span class="sd">        requirement_sections (dict): The requirement sections to process.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">chain</span><span class="p">:</span> <span class="n">GSPRChain</span><span class="p">,</span>
        <span class="n">context</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">concurrency_limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">component_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot; unknown&quot;</span><span class="p">,</span>
        <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">job_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">requirement_sections</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chain</span> <span class="o">=</span> <span class="n">chain</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_context</span> <span class="o">=</span> <span class="n">context</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">concurrency_limit</span> <span class="o">=</span> <span class="n">concurrency_limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memory</span> <span class="o">=</span> <span class="n">InMemorySaver</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_graph</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">component_name</span> <span class="o">=</span> <span class="n">component_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span> <span class="o">=</span> <span class="n">session_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span> <span class="o">=</span> <span class="n">job_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requirement_sections</span> <span class="o">=</span> <span class="n">requirement_sections</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initialized GSPRGraph for component: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">component_name</span><span class="si">}</span><span class="s2">, job_id: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">job_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># ---------------------------------------------------------------------</span>
    <span class="c1"># Public API</span>
    <span class="c1"># ---------------------------------------------------------------------</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">sections</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Bulk processing entrypoint for GSPR generation.</span>

<span class="sd">        Args:</span>
<span class="sd">            sections (list[dict[str, Any]]): The list of sections to process.</span>
<span class="sd">            session_id (str, optional): The session identifier for the current run.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict[str, Any]: The results of the GSPR generation, including context,</span>
<span class="sd">            grouped sections, results, and any errors encountered.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">initial</span><span class="p">:</span> <span class="n">GSPRState</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;context&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_context</span><span class="p">,</span>
            <span class="s2">&quot;component_name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">component_name</span><span class="p">,</span>
            <span class="s2">&quot;all_sections&quot;</span><span class="p">:</span> <span class="n">sections</span><span class="p">,</span>
            <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">}</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting GSPRGraph run for component: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">component_name</span><span class="si">}</span><span class="s2"> with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sections</span><span class="p">)</span><span class="si">}</span><span class="s2"> sections.&quot;</span><span class="p">)</span>
        <span class="c1"># Configure checkpointer with thread_id</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">RunnableConfig</span><span class="p">(</span><span class="n">configurable</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;thread_id&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;gspr-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">component_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">})</span>
        <span class="n">final</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">GSPRState</span><span class="p">,</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">ainvoke</span><span class="p">(</span><span class="n">initial</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;GSPRGraph run complete for component: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">component_name</span><span class="si">}</span><span class="s2">. Errors: </span><span class="si">{</span><span class="n">final</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;errors&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">[])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;context&quot;</span><span class="p">:</span> <span class="n">final</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;context&quot;</span><span class="p">,</span> <span class="p">{}),</span>
            <span class="s2">&quot;grouped_sections&quot;</span><span class="p">:</span> <span class="n">final</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;grouped_sections&quot;</span><span class="p">,</span> <span class="p">[]),</span>
            <span class="s2">&quot;results&quot;</span><span class="p">:</span> <span class="n">final</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;group_results&quot;</span><span class="p">,</span> <span class="p">[]),</span>
            <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="n">final</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;errors&quot;</span><span class="p">,</span> <span class="p">[]),</span>
        <span class="p">}</span>

    <span class="c1"># ---------------------------------------------------------------------</span>
    <span class="c1"># LangGraph: Build graph</span>
    <span class="c1"># ---------------------------------------------------------------------</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_build_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Builds the LangGraph instance for the GSPR workflow.</span>

<span class="sd">        Returns:</span>
<span class="sd">            StateGraph: The compiled LangGraph instance with nodes and edges defined.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">StateGraph</span><span class="p">(</span><span class="n">GSPRState</span><span class="p">)</span>

        <span class="n">builder</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;context_builder&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context_builder</span><span class="p">)</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;section_grouper&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_section_grouper</span><span class="p">)</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="s2">&quot;group_runner&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_runner</span><span class="p">)</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">add_conditional_edges</span><span class="p">(</span><span class="s2">&quot;context_builder&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_route_from_context_builder</span><span class="p">)</span>

        <span class="n">builder</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">START</span><span class="p">,</span> <span class="s2">&quot;context_builder&quot;</span><span class="p">)</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;section_grouper&quot;</span><span class="p">,</span> <span class="s2">&quot;group_runner&quot;</span><span class="p">)</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="s2">&quot;group_runner&quot;</span><span class="p">,</span> <span class="n">END</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">builder</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">checkpointer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">memory</span><span class="p">)</span>

    <span class="c1"># ---------------------------------------------------------------------</span>
    <span class="c1"># Router</span>
    <span class="c1"># ---------------------------------------------------------------------</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_route_from_context_builder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">GSPRState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">state</span><span class="p">[</span><span class="s2">&quot;component_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">component_name</span>
        <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;all_sections&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;section_grouper&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;GSPRGraph: No &#39;all_sections&#39; provided; finishing.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">END</span>  <span class="c1"># type: ignore[return-value]</span>

    <span class="c1"># ---------------------------------------------------------------------</span>
    <span class="c1"># Node: Context Builder</span>
    <span class="c1"># ---------------------------------------------------------------------</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_context_builder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">GSPRState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GSPRState</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Step 1 ‚Äî determine adaptive temperature for this node</span>
            <span class="n">temperature</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">determine_temperature</span><span class="p">(</span>
                <span class="n">node_title</span><span class="o">=</span><span class="s2">&quot;Context Builder&quot;</span><span class="p">,</span>
                <span class="n">context</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;phase&quot;</span><span class="p">:</span> <span class="s2">&quot;initial_context_building&quot;</span><span class="p">},</span>
            <span class="p">)</span>

            <span class="c1"># Step 2 ‚Äî run context building with that temperature</span>
            <span class="n">enriched</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">build_context</span><span class="p">(</span>
                <span class="n">base_context</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;context&quot;</span><span class="p">,</span> <span class="p">{}),</span>
                <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;context&quot;</span><span class="p">:</span> <span class="n">enriched</span><span class="p">,</span> <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="n">temperature</span><span class="p">}</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Context builder failed: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;context&quot;</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;context&quot;</span><span class="p">,</span> <span class="p">{}),</span> <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)]}</span>

    <span class="c1"># ---------------------------------------------------------------------</span>
    <span class="c1"># Node: Section Grouper</span>
    <span class="c1"># ---------------------------------------------------------------------</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_section_grouper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">GSPRState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GSPRState</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;section grouper called&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;......................&quot;</span><span class="p">)</span>
        <span class="n">sections</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;all_sections&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of sections: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sections</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;#####################################&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sections</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;grouped_sections&quot;</span><span class="p">:</span> <span class="p">[]}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># üî• Adaptive temperature reasoning for this node</span>
            <span class="n">temperature</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">determine_temperature</span><span class="p">(</span>
                <span class="n">node_title</span><span class="o">=</span><span class="s2">&quot;Section Grouper&quot;</span><span class="p">,</span>
                <span class="n">context</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;context&quot;</span><span class="p">,</span> <span class="p">{}),</span>
            <span class="p">)</span>

            <span class="c1"># Group sections semantically using LLM</span>
            <span class="n">grouped</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">group_sections</span><span class="p">(</span>
                <span class="n">sections</span><span class="o">=</span><span class="n">sections</span><span class="p">,</span>
                <span class="n">context</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;context&quot;</span><span class="p">,</span> <span class="p">{}),</span>
                <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Grouped sections: </span><span class="si">{</span><span class="n">grouped</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;#####################################&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;section grouper ended&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;grouped_sections&quot;</span><span class="p">:</span> <span class="n">grouped</span><span class="p">,</span> <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="n">temperature</span><span class="p">}</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Section grouper failed: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;grouped_sections&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)]}</span>

    <span class="c1"># Node: Group Runner</span>
    <span class="c1"># ---------------------------------------------------------------------</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_group_runner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">GSPRState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GSPRState</span><span class="p">:</span>
        <span class="n">grouped</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;grouped_sections&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">grouped</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;group_results&quot;</span><span class="p">:</span> <span class="p">[]}</span>

        <span class="n">semaphore</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Semaphore</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concurrency_limit</span><span class="p">)</span>
        <span class="n">results</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_run_one</span><span class="p">(</span><span class="n">group_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">section</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">async</span> <span class="k">with</span> <span class="n">semaphore</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Publish section started event</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span><span class="p">:</span>
                        <span class="kn">from</span><span class="w"> </span><span class="nn">regulatory.app.core.state</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_job_manager</span>

                        <span class="n">job_mgr</span> <span class="o">=</span> <span class="n">get_job_manager</span><span class="p">()</span>
                        <span class="n">job_mgr</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">section_started</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_id</span><span class="p">,</span> <span class="n">section_no</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">section_id</span><span class="o">=</span><span class="n">section</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">),</span> <span class="n">requirement_type</span><span class="o">=</span><span class="n">section</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;requirement_type&quot;</span><span class="p">,</span> <span class="s2">&quot;Unknown&quot;</span><span class="p">),</span> <span class="n">title</span><span class="o">=</span><span class="n">section</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Published section_started event for section </span><span class="si">{</span><span class="n">section</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> in job </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">job_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="c1"># üî• Temperature reasoning for this specific section</span>
                    <span class="n">temp_value</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">determine_temperature</span><span class="p">(</span>
                        <span class="n">node_title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="s2"> ‚Äî </span><span class="si">{</span><span class="n">section</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">context</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;context&quot;</span><span class="p">,</span> <span class="p">{}),</span>
                    <span class="p">)</span>

                    <span class="n">out</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">generate_section</span><span class="p">(</span>
                        <span class="n">session_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span>
                        <span class="n">section</span><span class="o">=</span><span class="n">section</span><span class="p">,</span>
                        <span class="n">context</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;context&quot;</span><span class="p">,</span> <span class="p">{}),</span>
                        <span class="n">group_name</span><span class="o">=</span><span class="n">group_name</span><span class="p">,</span>
                        <span class="n">component_name</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;component_name&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">),</span>
                        <span class="n">temperature</span><span class="o">=</span><span class="n">temp_value</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="n">section_result</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="o">**</span><span class="n">out</span><span class="p">,</span>
                        <span class="s2">&quot;section_id&quot;</span><span class="p">:</span> <span class="n">section</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">),</span>
                        <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">section</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">),</span>
                        <span class="s2">&quot;group&quot;</span><span class="p">:</span> <span class="n">group_name</span><span class="p">,</span>
                        <span class="s2">&quot;temperature_used&quot;</span><span class="p">:</span> <span class="n">temp_value</span><span class="p">,</span>
                    <span class="p">}</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">section_result</span><span class="p">)</span>

                    <span class="c1"># Update job manager progress for real-time streaming</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span><span class="p">:</span>
                        <span class="kn">from</span><span class="w"> </span><span class="nn">regulatory.app.core.state</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_job_manager</span>

                        <span class="n">job_mgr</span> <span class="o">=</span> <span class="n">get_job_manager</span><span class="p">()</span>

                        <span class="c1"># Check if section was successful - look for success status or applicable</span>
                        <span class="n">is_success</span> <span class="o">=</span> <span class="n">section_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;success&quot;</span> <span class="ow">or</span> <span class="n">section_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;is_applicable&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">is_success</span><span class="p">:</span>
                            <span class="n">job_mgr</span><span class="o">.</span><span class="n">update_progress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_id</span><span class="p">,</span> <span class="n">inc_completed</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                            <span class="c1"># Publish section completed event with proper data</span>
                            <span class="n">job_mgr</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">section_completed</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span><span class="p">,</span>
                                <span class="n">section_no</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">),</span>
                                <span class="n">title</span><span class="o">=</span><span class="n">section</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                                <span class="n">requirement_type</span><span class="o">=</span><span class="n">section</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;requirement_type&quot;</span><span class="p">,</span> <span class="s2">&quot;Unknown&quot;</span><span class="p">),</span>
                                <span class="n">section_id</span><span class="o">=</span><span class="n">section</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">),</span>
                                <span class="n">applicable</span><span class="o">=</span><span class="n">out</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;is_applicable&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
                                <span class="n">requirement_justification</span><span class="o">=</span><span class="n">out</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;requirement_justification&quot;</span><span class="p">,</span> <span class="s2">&quot;Not specified&quot;</span><span class="p">),</span>
                                <span class="n">standard</span><span class="o">=</span><span class="n">out</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;standard&quot;</span><span class="p">,</span> <span class="s2">&quot;None&quot;</span><span class="p">),</span>
                            <span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Section </span><span class="si">{</span><span class="n">section</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> completed - Standard: </span><span class="si">{</span><span class="n">out</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;standard&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;None&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">, Applicable: </span><span class="si">{</span><span class="n">out</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;is_applicable&#39;</span><span class="p">,</span><span class="w"> </span><span class="kc">False</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">job_mgr</span><span class="o">.</span><span class="n">update_progress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_id</span><span class="p">,</span> <span class="n">inc_completed</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Still count as completed even if not applicable</span>
                            <span class="c1"># Publish section completed event for non-applicable sections</span>
                            <span class="n">job_mgr</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">section_completed</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span><span class="p">,</span>
                                <span class="n">section_no</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">),</span>
                                <span class="n">title</span><span class="o">=</span><span class="n">section</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                                <span class="n">requirement_type</span><span class="o">=</span><span class="n">section</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;requirement_type&quot;</span><span class="p">,</span> <span class="s2">&quot;Unknown&quot;</span><span class="p">),</span>
                                <span class="n">section_id</span><span class="o">=</span><span class="n">section</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">),</span>
                                <span class="n">applicable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                <span class="n">requirement_justification</span><span class="o">=</span><span class="n">out</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;requirement_justification&quot;</span><span class="p">,</span> <span class="s2">&quot;Not applicable&quot;</span><span class="p">),</span>
                                <span class="n">standard</span><span class="o">=</span><span class="n">out</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;standard&quot;</span><span class="p">,</span> <span class="s2">&quot;None&quot;</span><span class="p">),</span>
                            <span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Section </span><span class="si">{</span><span class="n">section</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> completed as not applicable - Standard: </span><span class="si">{</span><span class="n">out</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;standard&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;None&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="c1"># Save results to session manager after every result</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">session_mgr</span> <span class="o">=</span> <span class="n">get_session_manager</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">session_mgr</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span><span class="p">:</span>
                            <span class="n">session_mgr</span><span class="o">.</span><span class="n">update_nested</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;gspr_section_results&quot;</span><span class="p">:</span> <span class="p">{</span><span class="nb">str</span><span class="p">(</span><span class="n">section</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)):</span> <span class="n">section_result</span><span class="p">}})</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Updated session with result for section </span><span class="si">{</span><span class="n">section</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">session_error</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to update session for section </span><span class="si">{</span><span class="n">section</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">session_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">error_result</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;section_id&quot;</span><span class="p">:</span> <span class="n">section</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">),</span>
                        <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">section</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">),</span>
                        <span class="s2">&quot;group&quot;</span><span class="p">:</span> <span class="n">group_name</span><span class="p">,</span>
                        <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                        <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;failed&quot;</span><span class="p">,</span>
                    <span class="p">}</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error_result</span><span class="p">)</span>

                    <span class="c1"># Update job manager for failed section</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span><span class="p">:</span>
                        <span class="kn">from</span><span class="w"> </span><span class="nn">regulatory.app.core.state</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_job_manager</span>

                        <span class="n">job_mgr</span> <span class="o">=</span> <span class="n">get_job_manager</span><span class="p">()</span>
                        <span class="n">job_mgr</span><span class="o">.</span><span class="n">update_progress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_id</span><span class="p">,</span> <span class="n">inc_failed</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="c1"># Publish section failed event</span>
                        <span class="n">job_mgr</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">section_failed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_id</span><span class="p">,</span> <span class="n">section_no</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">),</span> <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">attempts</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Section </span><span class="si">{</span><span class="n">section</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> failed with error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">, updated progress for job </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">job_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">session_mgr</span> <span class="o">=</span> <span class="n">get_session_manager</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">session_mgr</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span><span class="p">:</span>
                            <span class="n">session_mgr</span><span class="o">.</span><span class="n">update_nested</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;gspr_section_results&quot;</span><span class="p">:</span> <span class="p">{</span><span class="nb">str</span><span class="p">(</span><span class="n">section</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)):</span> <span class="n">error_result</span><span class="p">}})</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Updated session with error for section </span><span class="si">{</span><span class="n">section</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">session_error</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to update session for failed section </span><span class="si">{</span><span class="n">section</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">session_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># Append to state[&quot;group_results&quot;] if it exists</span>
                <span class="k">if</span> <span class="s2">&quot;group_results&quot;</span> <span class="ow">in</span> <span class="n">state</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;group_results&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">state</span><span class="p">[</span><span class="s2">&quot;group_results&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">_run_one</span><span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="s2">&quot;group&quot;</span><span class="p">],</span> <span class="n">s</span><span class="p">))</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">grouped</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sections&quot;</span><span class="p">,</span> <span class="p">[])]</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;üéØ All </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="si">}</span><span class="s2"> sections processed. Saving complete analysis results...&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;group_results&quot;</span><span class="p">:</span> <span class="n">results</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="core.graph.gspr_graph.GSPRGraph.run" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">run</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">sections</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Bulk processing entrypoint for GSPR generation.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>sections</code>
            </td>
            <td>
                  <code><span title="list">list</span>[<span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The list of sections to process.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>session_id</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The session identifier for the current run.</p>
              </div>
            </td>
            <td>
                  <code>&#39;&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>dict[str, Any]: The results of the GSPR generation, including context,</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>grouped sections, results, and any errors encountered.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>core/graph/gspr_graph.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">sections</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
    <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Bulk processing entrypoint for GSPR generation.</span>

<span class="sd">    Args:</span>
<span class="sd">        sections (list[dict[str, Any]]): The list of sections to process.</span>
<span class="sd">        session_id (str, optional): The session identifier for the current run.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict[str, Any]: The results of the GSPR generation, including context,</span>
<span class="sd">        grouped sections, results, and any errors encountered.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">initial</span><span class="p">:</span> <span class="n">GSPRState</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;context&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_context</span><span class="p">,</span>
        <span class="s2">&quot;component_name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">component_name</span><span class="p">,</span>
        <span class="s2">&quot;all_sections&quot;</span><span class="p">:</span> <span class="n">sections</span><span class="p">,</span>
        <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="p">}</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting GSPRGraph run for component: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">component_name</span><span class="si">}</span><span class="s2"> with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sections</span><span class="p">)</span><span class="si">}</span><span class="s2"> sections.&quot;</span><span class="p">)</span>
    <span class="c1"># Configure checkpointer with thread_id</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">RunnableConfig</span><span class="p">(</span><span class="n">configurable</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;thread_id&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;gspr-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">component_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">})</span>
    <span class="n">final</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">GSPRState</span><span class="p">,</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">ainvoke</span><span class="p">(</span><span class="n">initial</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;GSPRGraph run complete for component: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">component_name</span><span class="si">}</span><span class="s2">. Errors: </span><span class="si">{</span><span class="n">final</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;errors&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">[])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;context&quot;</span><span class="p">:</span> <span class="n">final</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;context&quot;</span><span class="p">,</span> <span class="p">{}),</span>
        <span class="s2">&quot;grouped_sections&quot;</span><span class="p">:</span> <span class="n">final</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;grouped_sections&quot;</span><span class="p">,</span> <span class="p">[]),</span>
        <span class="s2">&quot;results&quot;</span><span class="p">:</span> <span class="n">final</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;group_results&quot;</span><span class="p">,</span> <span class="p">[]),</span>
        <span class="s2">&quot;errors&quot;</span><span class="p">:</span> <span class="n">final</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;errors&quot;</span><span class="p">,</span> <span class="p">[]),</span>
    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="core.graph.gspr_graph.GSPRState" class="doc doc-heading">
            <code>GSPRState</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="typing_extensions.TypedDict">TypedDict</span></code></p>



        <p>Shared state passed between LangGraph nodes.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>core/graph/gspr_graph.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">GSPRState</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Shared state passed between LangGraph nodes.&quot;&quot;&quot;</span>

    <span class="n">messages</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="n">add_messages</span><span class="p">]</span>
    <span class="n">context</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="n">component_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">all_sections</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span>
    <span class="n">grouped_sections</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span>

    <span class="n">result</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="n">group_results</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span>
    <span class="n">errors</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>

    <span class="c1"># Adaptive parameters</span>
    <span class="n">temperature</span><span class="p">:</span> <span class="nb">float</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>




  </div>

    </div>

</div></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js"></script>
        <script src="../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
