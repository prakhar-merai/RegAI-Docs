<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Chains Overview - Regulatory AI Docs</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../css/brands.min.css" rel="stylesheet">
        <link href="../../css/solid.min.css" rel="stylesheet">
        <link href="../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <link href="../../assets/_mkdocstrings.css" rel="stylesheet">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">Regulatory AI Docs</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item">
                                <a href="../.." class="nav-link">Home</a>
                            </li>
                            <li class="nav-item">
                                <a href="../../getting-started/" class="nav-link">Getting Started</a>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">API Reference</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../api/design_template/template_api/" class="dropdown-item">Design Template API</a>
</li>
                                    
<li>
    <a href="../../api/gspr_table/gspr_table_api/" class="dropdown-item">GSPR Table API</a>
</li>
                                    
<li>
    <a href="../../api/design_input/design_input/" class="dropdown-item">Design Input API</a>
</li>
                                    
<li>
    <a href="../../api/design_output/design_output/" class="dropdown-item">Design Output API</a>
</li>
                                    
<li>
    <a href="../../api/projects/projects_api/" class="dropdown-item">Projects API</a>
</li>
                                    
<li>
    <a href="../../api/session/session_api/" class="dropdown-item">Sessions API</a>
</li>
                                    
<li>
    <a href="../../api/other_api/other_api/" class="dropdown-item">Other APIs</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Database & Schemas</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../database_and_schemas/databases_overview/" class="dropdown-item">Databases Overview</a>
</li>
                                    
<li>
    <a href="../../database_and_schemas/schemas/" class="dropdown-item">APIs Response Schemas</a>
</li>
                                    
<li>
    <a href="../../database_and_schemas/other/" class="dropdown-item">Other</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle active" aria-current="page" role="button" data-bs-toggle="dropdown"  aria-expanded="false">AI Backend</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="./" class="dropdown-item active" aria-current="page">Chains Overview</a>
</li>
                                    
<li>
    <a href="../agents/" class="dropdown-item">Workflows Overview</a>
</li>
                                    
<li>
    <a href="../graphs/" class="dropdown-item">Graph Nodes</a>
</li>
                                    
<li>
    <a href="../output_models/" class="dropdown-item">Output Models</a>
</li>
                                    
<li>
    <a href="../prompts/" class="dropdown-item">Prompts</a>
</li>
                                    
<li>
    <a href="../others/" class="dropdown-item">Other Modules</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item">
                                <a href="../../faq/" class="nav-link">FAQ</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../../database_and_schemas/other/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../agents/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#core-processing-chains-regulatory-ai" class="nav-link">‚öôÔ∏è Core Processing Chains ‚Äî Regulatory AI</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#component-recommender-chain-smart-component-suggestions" class="nav-link">üîß Component Recommender Chain - Smart Component Suggestions</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#core.chains.component_recommender_chain" class="nav-link">component_recommender_chain</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#core.chains.component_recommender_chain.get_component_recommender_chain" class="nav-link">get_component_recommender_chain</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#core.chains.component_recommender_chain.get_component_recommender_llm" class="nav-link">get_component_recommender_llm</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#design-input-chain-structure-validate-inputs" class="nav-link">üìù Design Input Chain ‚Äî Structure &amp; Validate Inputs</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#core.chains.design_input_chain" class="nav-link">design_input_chain</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#core.chains.design_input_chain.driver" class="nav-link">driver</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#core.chains.design_input_chain.fetch_design_input" class="nav-link">fetch_design_input</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#design-output-chain-transform-inputs-regulatory-outputs" class="nav-link">üì§ Design Output Chain ‚Äî Transform Inputs ‚Üí Regulatory Outputs</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#core.chains.design_output_chain" class="nav-link">design_output_chain</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#core.chains.design_output_chain.run_design_output_chain" class="nav-link">run_design_output_chain</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#gspr-chain-analyze-compliance-against-gspr" class="nav-link">üõ°Ô∏è GSPR Chain ‚Äî Analyze Compliance Against GSPR</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#core.chains.gspr_chain" class="nav-link">gspr_chain</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#core.chains.gspr_chain.GSPRChain" class="nav-link">GSPRChain</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#gspr-generator-chain-build-gspr-documentation" class="nav-link">üèóÔ∏è GSPR Generator Chain ‚Äî Build GSPR Documentation</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#core.chains.gspr_generator_chain" class="nav-link">gspr_generator_chain</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#core.chains.gspr_generator_chain.prompt" class="nav-link">prompt</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#core.chains.gspr_generator_chain.get_gspr_generator_chain" class="nav-link">get_gspr_generator_chain</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#core.chains.gspr_generator_chain.get_gspr_generator_llm" class="nav-link">get_gspr_generator_llm</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#guard-chain-apply-rule-based-validations" class="nav-link">üö® Guard Chain ‚Äî Apply Rule-Based Validations</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#core.chains.guard_chain" class="nav-link">guard_chain</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#core.chains.guard_chain.get_guard_chain" class="nav-link">get_guard_chain</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#core.chains.guard_chain.get_guard_llm" class="nav-link">get_guard_llm</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#intended-user-chain-identify-expected-user-profiles" class="nav-link">üë• Intended User Chain ‚Äî Identify Expected User Profiles</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#core.chains.intended_user_chain" class="nav-link">intended_user_chain</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#core.chains.intended_user_chain.prompt" class="nav-link">prompt</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#core.chains.intended_user_chain.get_intended_user_chain" class="nav-link">get_intended_user_chain</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#core.chains.intended_user_chain.get_intended_user_llm" class="nav-link">get_intended_user_llm</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#risk-classification-chain-determine-device-risk-class" class="nav-link">üß™ Risk Classification Chain ‚Äî Determine Device Risk Class</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#core.chains.risk_classification_chain" class="nav-link">risk_classification_chain</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#core.chains.risk_classification_chain.get_llm_for_region" class="nav-link">get_llm_for_region</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#core.chains.risk_classification_chain.get_risk_classification_chain" class="nav-link">get_risk_classification_chain</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#core.chains.risk_classification_chain.get_risk_classification_llm" class="nav-link">get_risk_classification_llm</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="core-processing-chains-regulatory-ai">‚öôÔ∏è Core Processing Chains ‚Äî Regulatory AI</h1>
<hr />
<h2 id="component-recommender-chain-smart-component-suggestions">üîß Component Recommender Chain - Smart Component Suggestions</h2>
<p>Analyzes device attributes and intelligently proposes <strong>optimal components</strong> required for regulatory and technical completeness.<br />
Ensures alignment between device structure and regulatory expectations.</p>


<div class="doc doc-object doc-module">



<a id="core.chains.component_recommender_chain"></a>
    <div class="doc doc-contents first">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h2 id="core.chains.component_recommender_chain.get_component_recommender_chain" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_component_recommender_chain</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Get component recommender chain with current model selection.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>core/chains/component_recommender_chain.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_component_recommender_chain</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get component recommender chain with current model selection.&quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating component recommender chain with current model...&quot;</span><span class="p">)</span>
    <span class="n">component_recommender_llm</span> <span class="o">=</span> <span class="n">get_component_recommender_llm</span><span class="p">()</span>
    <span class="n">chain</span> <span class="o">=</span> <span class="n">prompt</span> <span class="o">|</span> <span class="n">component_recommender_llm</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Component recommender chain created successfully.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">chain</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="core.chains.component_recommender_chain.get_component_recommender_llm" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_component_recommender_llm</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Get LLM instance with current model selection for runtime switching.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>core/chains/component_recommender_chain.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_component_recommender_llm</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get LLM instance with current model selection for runtime switching.&quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating LLM instance with current model selection...&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">llm</span> <span class="o">=</span> <span class="n">get_vllm_llm</span><span class="p">()</span>  <span class="c1"># This will use the current selected model</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;LLM initialized successfully.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">llm</span><span class="o">.</span><span class="n">with_structured_output</span><span class="p">(</span><span class="n">ComponentRecommenderModel</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Failed to initialize LLM: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;LLM initialization exception message: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><hr />
<h2 id="design-input-chain-structure-validate-inputs">üìù Design Input Chain ‚Äî Structure &amp; Validate Inputs</h2>
<p>Processes raw session data into structured <strong>design input specifications</strong>, ensuring clarity, consistency, and readiness for downstream modules.<br />
Acts as the foundation of compliant design documentation.</p>


<div class="doc doc-object doc-module">



<a id="core.chains.design_input_chain"></a>
    <div class="doc doc-contents first">










  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h2 id="core.chains.design_input_chain.driver" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">driver</span> <span class="o">=</span> <span class="n">GraphDatabase</span><span class="o">.</span><span class="n">driver</span><span class="p">(</span><span class="n">NEO4J_URI</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="p">(</span><span class="n">NEO4J_USER</span><span class="p">,</span> <span class="n">NEO4J_PASSWORD</span><span class="p">))</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">

        <p>Fetch design input details for a specific GSPR clause.</p>
<p>This function queries the Neo4j database for details related to a specific GSPR clause,
including requirement types, standards, and justifications. It then uses a language
model to generate structured design input data.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>device_meta</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Metadata about the device, including type, purpose, users, and risks.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>component</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the component being processed.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>gspr_no</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The GSPR clause number to query.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>DesignInputModel</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A structured model containing the design input details, including</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>component, requirement, GSPR text, and associated standards.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <p>device_meta = {
    "device_type": "Sensor",
    "intended_purpose": "Monitoring",
    "intended_users": ["Doctors", "Nurses"],
    "risk_classification": "Class II"
}
design_input = fetch_design_input(device_meta, "Sensor", "5.1")</p>
<p>Response:
DesignInputModel(
    component="Sensor",
    requirement="Safety",
    gspr_text="Ensure device safety under normal conditions.",
    standards=[...]
)</p>
</details>
    </div>

</div>




<div class="doc doc-object doc-function">


<h2 id="core.chains.design_input_chain.fetch_design_input" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">fetch_design_input</span><span class="p">(</span><span class="n">device_meta</span><span class="p">,</span> <span class="n">component</span><span class="p">,</span> <span class="n">gspr_no</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Query Neo4j for a specific GSPRClause, fetch requirement type, standards,
and run it through the LLM to generate structured output.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>core/chains/design_input_chain.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">fetch_design_input</span><span class="p">(</span><span class="n">device_meta</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">component</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">gspr_no</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DesignInputModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Query Neo4j for a specific GSPRClause, fetch requirement type, standards,</span>
<span class="sd">    and run it through the LLM to generate structured output.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    MATCH (g:GSPRClause {name: $gspr_no})</span>
<span class="s2">    OPTIONAL MATCH (g)-[:HAS_TYPE]-&gt;(r:RequirementType)</span>
<span class="s2">    OPTIONAL MATCH (g)-[rel:ADDRESSED_BY]-&gt;(s:Standard)</span>
<span class="s2">    RETURN g.name AS gspr_no,</span>
<span class="s2">           g.text AS gspr_text,</span>
<span class="s2">           g.applicability AS applicability,</span>
<span class="s2">           r.name AS requirement,</span>
<span class="s2">           s.name AS standard,</span>
<span class="s2">           rel.justification AS justification</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="n">standards_info</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">gspr_text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">applicability</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">requirement</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">with</span> <span class="n">driver</span><span class="o">.</span><span class="n">session</span><span class="p">(</span><span class="n">database</span><span class="o">=</span><span class="n">NEO4J_DATABASE</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">gspr_no</span><span class="o">=</span><span class="n">gspr_no</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="n">gspr_text</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="s2">&quot;gspr_text&quot;</span><span class="p">]</span>
            <span class="n">applicability</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="s2">&quot;applicability&quot;</span><span class="p">]</span>
            <span class="n">requirement</span> <span class="o">=</span> <span class="n">record</span><span class="p">[</span><span class="s2">&quot;requirement&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="n">record</span><span class="p">[</span><span class="s2">&quot;standard&quot;</span><span class="p">]:</span>
                <span class="n">standards_info</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">&quot;standard&quot;</span><span class="p">:</span> <span class="n">record</span><span class="p">[</span><span class="s2">&quot;standard&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;justification&quot;</span><span class="p">:</span> <span class="n">record</span><span class="p">[</span><span class="s2">&quot;justification&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;gspr_text&quot;</span><span class="p">:</span> <span class="n">gspr_text</span><span class="p">,</span>
                    <span class="s2">&quot;applicability&quot;</span><span class="p">:</span> <span class="n">applicability</span><span class="p">,</span>
                    <span class="s2">&quot;requirement&quot;</span><span class="p">:</span> <span class="n">requirement</span><span class="p">,</span>
                <span class="p">})</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">standards_info</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No standards found in KG for GSPR &#39;</span><span class="si">{</span><span class="n">gspr_no</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">DesignInputModel</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="n">component</span><span class="p">,</span> <span class="n">requirement</span><span class="o">=</span><span class="n">requirement</span><span class="p">,</span> <span class="n">gspr_text</span><span class="o">=</span><span class="n">gspr_text</span><span class="p">,</span> <span class="n">standards</span><span class="o">=</span><span class="p">[])</span>

    <span class="c1"># Build standards_context</span>
    <span class="n">standards_context</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">standards_info</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">standards_context</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">=== Context for Standard </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;standard&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> ===</span>
<span class="s2">‚Ä¢ Component: </span><span class="si">{</span><span class="n">component</span><span class="si">}</span>
<span class="s2">‚Ä¢ Requirement: </span><span class="si">{</span><span class="n">requirement</span><span class="si">}</span>
<span class="s2">‚Ä¢ GSPR Number: </span><span class="si">{</span><span class="n">gspr_no</span><span class="si">}</span>
<span class="s2">‚Ä¢ GSPR Clause Text: </span><span class="si">{</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;gspr_text&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">‚Ä¢ Applicability: </span><span class="si">{</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;applicability&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">‚Ä¢ Raw Justification (from KG): </span><span class="si">{</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;justification&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">&quot;&quot;&quot;</span>

    <span class="c1"># Create prompt</span>
    <span class="n">prompt</span> <span class="o">=</span> <span class="n">PromptTemplate</span><span class="p">(</span>
        <span class="n">template</span><span class="o">=</span><span class="n">DESIGN_INPUT_GENERATOR_PROMPT</span><span class="p">,</span>
        <span class="n">input_variables</span><span class="o">=</span><span class="p">[</span>
            <span class="s2">&quot;device_type&quot;</span><span class="p">,</span>
            <span class="s2">&quot;intended_purpose&quot;</span><span class="p">,</span>
            <span class="s2">&quot;intended_users&quot;</span><span class="p">,</span>
            <span class="s2">&quot;risk_classifications&quot;</span><span class="p">,</span>
            <span class="s2">&quot;component&quot;</span><span class="p">,</span>
            <span class="s2">&quot;requirement&quot;</span><span class="p">,</span>
            <span class="s2">&quot;gspr_no&quot;</span><span class="p">,</span>
            <span class="s2">&quot;gspr_text&quot;</span><span class="p">,</span>
            <span class="s2">&quot;standards_context&quot;</span><span class="p">,</span>
        <span class="p">],</span>
    <span class="p">)</span>

    <span class="c1"># Initialize LLM with structured output</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">regulatory.core.llm.llm_provider</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_vllm_llm</span>
    <span class="n">llm</span> <span class="o">=</span> <span class="n">get_vllm_llm</span><span class="p">()</span>
    <span class="n">design_input_llm</span> <span class="o">=</span> <span class="n">llm</span><span class="o">.</span><span class="n">with_structured_output</span><span class="p">(</span><span class="n">DesignInputModel</span><span class="p">)</span>
    <span class="n">design_input_chain</span> <span class="o">=</span> <span class="n">prompt</span> <span class="o">|</span> <span class="n">design_input_llm</span>

    <span class="n">chain_input</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;device_type&quot;</span><span class="p">:</span> <span class="n">device_meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;device_type&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
        <span class="s2">&quot;intended_purpose&quot;</span><span class="p">:</span> <span class="n">device_meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;intended_purpose&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
        <span class="s2">&quot;intended_users&quot;</span><span class="p">:</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">device_meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;intended_users&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]),</span>
        <span class="s2">&quot;risk_classifications&quot;</span><span class="p">:</span> <span class="n">device_meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;risk_classification&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
        <span class="s2">&quot;component&quot;</span><span class="p">:</span> <span class="n">component</span><span class="p">,</span>
        <span class="s2">&quot;requirement&quot;</span><span class="p">:</span> <span class="n">requirement</span><span class="p">,</span>
        <span class="s2">&quot;gspr_no&quot;</span><span class="p">:</span> <span class="n">gspr_no</span><span class="p">,</span>
        <span class="s2">&quot;gspr_text&quot;</span><span class="p">:</span> <span class="n">gspr_text</span><span class="p">,</span>
        <span class="s2">&quot;standards_context&quot;</span><span class="p">:</span> <span class="n">standards_context</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fetching design input for component &#39;</span><span class="si">{</span><span class="n">component</span><span class="si">}</span><span class="s2">&#39;, GSPR &#39;</span><span class="si">{</span><span class="n">gspr_no</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">design_input_chain</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">chain_input</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="n">response</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">DesignInputModel</span><span class="p">)</span>
        <span class="k">else</span> <span class="n">DesignInputModel</span><span class="p">(</span><span class="o">**</span><span class="n">response</span><span class="p">)</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><hr />
<h2 id="design-output-chain-transform-inputs-regulatory-outputs">üì§ Design Output Chain ‚Äî Transform Inputs ‚Üí Regulatory Outputs</h2>
<p>Converts finalized, validated design inputs into formalized <strong>regulatory design documents</strong>.<br />
Handles formatting, integrity checks, and delivery of compliant output packages.</p>


<div class="doc doc-object doc-module">



<a id="core.chains.design_output_chain"></a>
    <div class="doc doc-contents first">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h2 id="core.chains.design_output_chain.run_design_output_chain" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">run_design_output_chain</span><span class="p">(</span><span class="n">design_input</span><span class="p">,</span> <span class="n">component</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">

        <p>Automatically generate a structured Design Output Report for a given medical device component.</p>
<p>This function does not require user text or PDF references.
Instead, it automatically utilizes the available design input data
(device type, requirements, standards, and GSPR text) to produce
a Design Output Report aligned with ISO/IEC standards.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>design_input</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing design data, including:
- device_type (str)
- component (str)
- requirement (str)
- gspr_text (str)
- standards (list[dict]) with 'name' and 'justification' fields</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>component</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the device component.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>str</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Generated Design Output Report (formatted table with Clause, Category, Standard, and Output Statement).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>core/chains/design_output_chain.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run_design_output_chain</span><span class="p">(</span><span class="n">design_input</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">component</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Automatically generate a structured Design Output Report for a given medical device component.</span>

<span class="sd">    This function does not require user text or PDF references.</span>
<span class="sd">    Instead, it automatically utilizes the available design input data</span>
<span class="sd">    (device type, requirements, standards, and GSPR text) to produce</span>
<span class="sd">    a Design Output Report aligned with ISO/IEC standards.</span>

<span class="sd">    Args:</span>
<span class="sd">        design_input (dict): Dictionary containing design data, including:</span>
<span class="sd">            - device_type (str)</span>
<span class="sd">            - component (str)</span>
<span class="sd">            - requirement (str)</span>
<span class="sd">            - gspr_text (str)</span>
<span class="sd">            - standards (list[dict]) with &#39;name&#39; and &#39;justification&#39; fields</span>
<span class="sd">        component (str): Name of the device component.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: Generated Design Output Report (formatted table with Clause, Category, Standard, and Output Statement).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Format standards context for LLM</span>
    <span class="n">standards_context</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;=== Standard: </span><span class="si">{</span><span class="n">std</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> ===</span><span class="se">\n</span><span class="s2">Justification: </span><span class="si">{</span><span class="n">std</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;justification&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">std</span> <span class="ow">in</span> <span class="n">design_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;standards&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="p">)</span>

    <span class="c1"># Prepare input payload for the LLM</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;device_type&quot;</span><span class="p">:</span> <span class="n">design_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;device_type&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
        <span class="s2">&quot;component&quot;</span><span class="p">:</span> <span class="n">component</span><span class="p">,</span>
        <span class="s2">&quot;requirement&quot;</span><span class="p">:</span> <span class="n">design_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;requirement&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
        <span class="s2">&quot;gspr_text&quot;</span><span class="p">:</span> <span class="n">design_input</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;gspr_text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
        <span class="s2">&quot;standards_context&quot;</span><span class="p">:</span> <span class="n">standards_context</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running Design Output Chain for component: &#39;</span><span class="si">{</span><span class="n">component</span><span class="si">}</span><span class="s2">&#39; (Auto ISO selection enabled)&quot;</span><span class="p">)</span>

    <span class="n">llm</span> <span class="o">=</span> <span class="n">get_vllm_llm</span><span class="p">()</span>
    <span class="n">chain</span> <span class="o">=</span> <span class="n">prompt</span> <span class="o">|</span> <span class="n">llm</span>

    <span class="c1"># Execute asynchronously and return generated content</span>
    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">chain</span><span class="o">.</span><span class="n">ainvoke</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">content</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><hr />
<h2 id="gspr-chain-analyze-compliance-against-gspr">üõ°Ô∏è GSPR Chain ‚Äî Analyze Compliance Against GSPR</h2>
<p>Evaluates device details against <strong>General Safety &amp; Performance Requirements (GSPR)</strong>.<br />
Identifies relevant clauses, compliance gaps, and required evidence for MDR conformity.</p>


<div class="doc doc-object doc-module">



<a id="core.chains.gspr_chain"></a>
    <div class="doc doc-contents first">

        <p>GSPRChain ‚Äî Prompt &amp; LLM Execution Layer (Async)</p>
<p>Responsibilities:
- Build prompts for GSPR reasoning steps
- Use LLM clients (from regulatory.core.llm)
- Return structured results for each reasoning phase</p>










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="core.chains.gspr_chain.GSPRChain" class="doc doc-heading">
            <code>GSPRChain</code>


</h2>


    <div class="doc doc-contents ">



        <p>Executes the core GSPR reasoning prompts using an async LLM client.</p>
<p>This is a fully production implementation using the real GPT-4o model.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>core/chains/gspr_chain.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">GSPRChain</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Executes the core GSPR reasoning prompts using an async LLM client.</span>

<span class="sd">    This is a fully production implementation using the real GPT-4o model.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;gpt-4o&quot;</span><span class="p">,</span>
        <span class="n">small_model_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;gpt-4o-mini&quot;</span><span class="p">,</span>
        <span class="n">temperature</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
        <span class="n">component_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;unknown&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="o">=</span> <span class="n">model_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">small_model_name</span> <span class="o">=</span> <span class="n">small_model_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span> <span class="o">=</span> <span class="n">temperature</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">llm</span> <span class="o">=</span> <span class="n">get_vllm_llm</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">small_llm</span> <span class="o">=</span> <span class="n">get_vllm_llm</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">small_model_name</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;GSPRChain initialized | main=</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2"> | small=</span><span class="si">{</span><span class="n">small_model_name</span><span class="si">}</span><span class="s2"> | temperature=</span><span class="si">{</span><span class="n">temperature</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># =========================================================</span>
    <span class="c1"># Internal Helper ‚Äî Generic async LLM call (text or structured)</span>
    <span class="c1"># =========================================================</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_llm_call</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">temperature</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">structured_schema</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Asynchronously call the configured LLM.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        prompt : str</span>
<span class="sd">            The formatted prompt text to send to the model.</span>
<span class="sd">        temperature : float, optional</span>
<span class="sd">            Override the default temperature for this specific call.</span>
<span class="sd">        structured_schema : pydantic.BaseModel | TypedDict | None</span>
<span class="sd">            If provided, returns structured output conforming to the schema</span>
<span class="sd">            using the model&#39;s `with_structured_output()` interface.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Any</span>
<span class="sd">            - If `structured_schema` is None ‚Üí str (LLM text output)</span>
<span class="sd">            - If `structured_schema` is provided ‚Üí instance of schema</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># choose LLM instance</span>
            <span class="k">if</span> <span class="n">temperature</span> <span class="ow">and</span> <span class="n">temperature</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span><span class="p">:</span>
                <span class="n">llm</span> <span class="o">=</span> <span class="n">get_vllm_llm</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">llm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span>

            <span class="c1"># structured output mode</span>
            <span class="k">if</span> <span class="n">structured_schema</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">llm_structured</span> <span class="o">=</span> <span class="n">llm</span><span class="o">.</span><span class="n">with_structured_output</span><span class="p">(</span>
                    <span class="n">structured_schema</span><span class="p">,</span>
                    <span class="n">method</span><span class="o">=</span><span class="s2">&quot;function_calling&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">llm_structured</span><span class="o">.</span><span class="n">ainvoke</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Structured LLM call executed using schema=</span><span class="si">{</span><span class="n">structured_schema</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">result</span>

            <span class="c1"># standard text generation mode</span>
            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">llm</span><span class="o">.</span><span class="n">ainvoke</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Text LLM call executed successfully.&quot;</span><span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">response</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;LLM call failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span>

    <span class="c1"># =========================================================</span>
    <span class="c1"># Context Builder</span>
    <span class="c1"># =========================================================</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">build_context</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">base_context</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">temperature</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Builds or enriches session context using regulatory reasoning.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">context</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">base_context</span> <span class="ow">or</span> <span class="p">{})</span>

        <span class="n">prompt</span> <span class="o">=</span> <span class="n">get_context_prompt</span><span class="p">()</span>
        <span class="n">formatted_prompt</span> <span class="o">=</span> <span class="n">prompt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">context_json</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_llm_call</span><span class="p">(</span>
            <span class="n">formatted_prompt</span><span class="p">,</span>
            <span class="n">structured_schema</span><span class="o">=</span><span class="n">ContextSummaryModel</span><span class="p">,</span>
            <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># If response is a Pydantic model instance, use its .model_dump() method</span>
        <span class="n">context</span><span class="p">[</span><span class="s2">&quot;summary&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Context successfully built via model </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">context</span>

    <span class="c1"># =========================================================</span>
    <span class="c1"># Section Grouper</span>
    <span class="c1"># =========================================================</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">group_sections</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sections</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">context</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">component_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">temperature</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.6</span><span class="p">,</span>  <span class="c1"># Higher temperature for more thoughtful analysis</span>
        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">25</span><span class="p">,</span>  <span class="c1"># Smaller batches for deeper focus</span>
        <span class="n">max_concurrency</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>  <span class="c1"># Reduced concurrency for more careful processing</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Groups sections semantically using GPT structured output with DEEP ANALYSIS.</span>

<span class="sd">        Performs comprehensive regulatory analysis by:</span>
<span class="sd">        - Analyzing both titles AND full descriptions</span>
<span class="sd">        - Using higher temperature for thoughtful reasoning</span>
<span class="sd">        - Smaller batch sizes for focused analysis</span>
<span class="sd">        - Single best-fit group assignment per section</span>
<span class="sd">        - Detailed timing and assignment statistics</span>

<span class="sd">        Returns: [{&quot;group&quot;: str, &quot;sections&quot;: [...] }] with single assignment per section</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># ------------------------------------------------------------</span>
        <span class="c1"># Split sections into manageable batches</span>
        <span class="c1"># ------------------------------------------------------------</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&quot;</span><span class="p">)</span>
        <span class="n">total_sections</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sections</span><span class="p">)</span>

        <span class="n">batches</span> <span class="o">=</span> <span class="p">[</span><span class="n">sections</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">total_sections</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="n">total_sections</span><span class="si">}</span><span class="s2"> sections in </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">batches</span><span class="p">)</span><span class="si">}</span><span class="s2"> batches (batch size=</span><span class="si">{</span><span class="n">batch_size</span><span class="si">}</span><span class="s2">, max_concurrency=</span><span class="si">{</span><span class="n">max_concurrency</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">)</span>

        <span class="c1"># ------------------------------------------------------------</span>
        <span class="c1"># Prepare title index for mapping back</span>
        <span class="c1"># ------------------------------------------------------------</span>
        <span class="n">title_index</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]:</span> <span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sections</span><span class="p">}</span>
        <span class="n">merged_groups</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">semaphore</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Semaphore</span><span class="p">(</span><span class="n">max_concurrency</span><span class="p">)</span>

        <span class="c1"># ------------------------------------------------------------</span>
        <span class="c1"># Helper to process a single batch</span>
        <span class="c1"># ------------------------------------------------------------</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_process_batch</span><span class="p">(</span><span class="n">batch</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">batch_num</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">component_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GroupingModel</span><span class="p">:</span>
            <span class="k">async</span> <span class="k">with</span> <span class="n">semaphore</span><span class="p">:</span>
                <span class="c1"># Create detailed sections with titles AND descriptions for analysis</span>
                <span class="n">sections_with_descriptions</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">section</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">title</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;Untitled Section&quot;</span><span class="p">)</span>
                    <span class="n">description</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="s2">&quot;No description available&quot;</span><span class="p">)</span>
                    <span class="c1"># Truncate very long descriptions to avoid token limits</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">description</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">:</span>
                        <span class="n">description</span> <span class="o">=</span> <span class="n">description</span><span class="p">[:</span><span class="mi">497</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;...&quot;</span>
                    <span class="n">sections_with_descriptions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. TITLE: </span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="se">\n</span><span class="s2">   DESCRIPTION: </span><span class="si">{</span><span class="n">description</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="n">sections_text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sections_with_descriptions</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Batch </span><span class="si">{</span><span class="n">batch_num</span><span class="si">}</span><span class="s2">] Deep analysis of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span><span class="si">}</span><span class="s2"> sectizons with full descriptions.&quot;</span><span class="p">)</span>

                <span class="n">prompt</span> <span class="o">=</span> <span class="n">get_grouping_prompt</span><span class="p">()</span>
                <span class="n">formatted_prompt</span> <span class="o">=</span> <span class="n">prompt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">context_summary</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="s2">&quot;N/A&quot;</span><span class="p">),</span>
                    <span class="n">sections_with_descriptions</span><span class="o">=</span><span class="n">sections_text</span><span class="p">,</span>
                    <span class="n">component_name</span><span class="o">=</span><span class="n">component_name</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># Structured JSON call per batch with timing</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

                <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>

                <span class="n">response</span><span class="p">:</span> <span class="n">GroupingModel</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_llm_call</span><span class="p">(</span>
                    <span class="n">formatted_prompt</span><span class="p">,</span>
                    <span class="n">structured_schema</span><span class="o">=</span><span class="n">GroupingModel</span><span class="p">,</span>
                    <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="n">processing_time</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

                <span class="c1"># Calculate assignment statistics for this batch</span>
                <span class="n">total_assignments</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">sections</span><span class="p">)</span> <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">groups</span><span class="p">)</span>
                <span class="n">batch_sections</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Batch </span><span class="si">{</span><span class="n">batch_num</span><span class="si">}</span><span class="s2">] Deep analysis completed in </span><span class="si">{</span><span class="n">processing_time</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Batch </span><span class="si">{</span><span class="n">batch_num</span><span class="si">}</span><span class="s2">] Single assignments: </span><span class="si">{</span><span class="n">total_assignments</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">batch_sections</span><span class="si">}</span><span class="s2"> sections assigned&quot;</span><span class="p">)</span>

                <span class="k">return</span> <span class="n">response</span>

        <span class="c1"># ------------------------------------------------------------</span>
        <span class="c1"># 4Ô∏è‚É£ Run all batches in parallel</span>
        <span class="c1"># ------------------------------------------------------------</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">_process_batch</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">component_name</span> <span class="ow">or</span> <span class="s2">&quot;unknown&quot;</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">batches</span><span class="p">)]</span>
        <span class="n">responses</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;All </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">responses</span><span class="p">)</span><span class="si">}</span><span class="s2"> batches completed.&quot;</span><span class="p">)</span>

        <span class="c1"># ------------------------------------------------------------</span>
        <span class="c1"># 5Ô∏è‚É£ Merge grouped results from all batches (SINGLE ASSIGNMENT ONLY)</span>
        <span class="c1"># ------------------------------------------------------------</span>
        <span class="k">for</span> <span class="n">batch_idx</span><span class="p">,</span> <span class="n">response</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">responses</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">batch_mapped_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">groups</span><span class="p">:</span>
                <span class="n">mapped_sections</span> <span class="o">=</span> <span class="p">[</span><span class="n">title_index</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">sections</span> <span class="k">if</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">title_index</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">group</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">merged_groups</span><span class="p">:</span>
                    <span class="n">merged_groups</span><span class="p">[</span><span class="n">group</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">merged_groups</span><span class="p">[</span><span class="n">group</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">mapped_sections</span><span class="p">)</span>
                <span class="n">batch_mapped_count</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mapped_sections</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Batch </span><span class="si">{</span><span class="n">batch_idx</span><span class="si">}</span><span class="s2">] Added </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">groups</span><span class="p">)</span><span class="si">}</span><span class="s2"> groups with </span><span class="si">{</span><span class="n">batch_mapped_count</span><span class="si">}</span><span class="s2"> sections.&quot;</span><span class="p">)</span>

        <span class="c1"># ------------------------------------------------------------</span>
        <span class="c1"># 6Ô∏è‚É£ Handle any missing titles (fallback for single assignments)</span>
        <span class="c1"># ------------------------------------------------------------</span>
        <span class="n">all_mapped_titles</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">merged_groups</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">g</span><span class="p">}</span>
        <span class="n">missing_sections</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sections</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">all_mapped_titles</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">missing_sections</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">missing_sections</span><span class="p">)</span><span class="si">}</span><span class="s2"> sections were unassigned ‚Äî adding to &#39;Miscellaneous&#39;.&quot;</span><span class="p">)</span>
            <span class="n">merged_groups</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;Miscellaneous&quot;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">missing_sections</span><span class="p">)</span>

        <span class="c1"># ------------------------------------------------------------</span>
        <span class="c1"># 7Ô∏è‚É£ Final structured result (single assignment per section)</span>
        <span class="c1"># ------------------------------------------------------------</span>
        <span class="n">grouped_sections</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;group&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="s2">&quot;sections&quot;</span><span class="p">:</span> <span class="n">secs</span><span class="p">}</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">secs</span> <span class="ow">in</span> <span class="n">merged_groups</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>

        <span class="c1"># Calculate statistics for single assignments</span>
        <span class="n">total_assigned</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">secs</span><span class="p">)</span> <span class="k">for</span> <span class="n">secs</span> <span class="ow">in</span> <span class="n">merged_groups</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">total_sections</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sections</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚úÖ Grouped </span><span class="si">{</span><span class="n">total_sections</span><span class="si">}</span><span class="s2"> sections into </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">grouped_sections</span><span class="p">)</span><span class="si">}</span><span class="s2"> groups.&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;üìä Assignment: </span><span class="si">{</span><span class="n">total_assigned</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">total_sections</span><span class="si">}</span><span class="s2"> sections assigned (single assignment per section).&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">grouped_sections</span>

    <span class="c1"># =========================================================</span>
    <span class="c1"># Section Generator</span>
    <span class="c1"># =========================================================</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">generate_section</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">section</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">context</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">component_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">group_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">temperature</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.4</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates the reasoning or compliance mapping for a single section.</span>
<span class="sd">        Returns: structured dict with standard, applicability, and justification.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;Unnamed Section&quot;</span><span class="p">)</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">prompt</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;You are an expert in regulatory compliance.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Section Title: </span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Group: </span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Component: </span><span class="si">{</span><span class="n">component_name</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Session Summary:</span><span class="se">\n</span><span class="si">{</span><span class="n">summary</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Section Text:</span><span class="se">\n</span><span class="si">{</span><span class="n">body</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;CRITICAL: You MUST respond in the exact format below. Do not include explanations or additional text.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Tasks:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;1. Identify ONE most relevant regulatory standard (ISO/FDA/MDR)</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;2. Decide if this requirement is applicable (yes/no)</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;3. Provide a brief justification (maximum 8 words)</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;REQUIRED FORMAT (copy exactly):</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;STANDARD: [standard name only]</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;APPLICABLE: [yes or no]</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;JUSTIFICATION: [brief reason]</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Good Examples:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;STANDARD: ISO 13485</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;APPLICABLE: yes</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;JUSTIFICATION: Supplier responsibility per QMS procedure</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;STANDARD: FDA 21 CFR 820</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;APPLICABLE: no</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;JUSTIFICATION: Not relevant for device type</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;STANDARD: None</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;APPLICABLE: no</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;JUSTIFICATION: Outside regulatory scope</span><span class="se">\n\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Respond ONLY in the required format above.&quot;</span>
        <span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_llm_call</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">)</span>

        <span class="c1"># Parse the structured response</span>
        <span class="n">standard</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span>
        <span class="n">applicable</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">justification</span> <span class="o">=</span> <span class="s2">&quot;Not specified&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Raw LLM response for section </span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">response</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;STANDARD:&quot;</span><span class="p">):</span>
                    <span class="n">standard</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;STANDARD:&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">standard</span><span class="p">:</span>
                        <span class="n">standard</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span>
                <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;APPLICABLE:&quot;</span><span class="p">):</span>
                    <span class="n">applicable</span> <span class="o">=</span> <span class="s2">&quot;yes&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;JUSTIFICATION:&quot;</span><span class="p">):</span>
                    <span class="n">justification</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;JUSTIFICATION:&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">justification</span><span class="p">:</span>
                        <span class="n">justification</span> <span class="o">=</span> <span class="s2">&quot;Not specified&quot;</span>

            <span class="c1"># Validate parsing results</span>
            <span class="k">if</span> <span class="n">standard</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span> <span class="ow">and</span> <span class="n">justification</span> <span class="o">==</span> <span class="s2">&quot;Not specified&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">applicable</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;LLM response parsing may have failed for section </span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">. Using fallback.&quot;</span><span class="p">)</span>
                <span class="c1"># Fallback parsing for unstructured response</span>
                <span class="k">if</span> <span class="s2">&quot;iso&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="n">standard</span> <span class="o">=</span> <span class="s2">&quot;ISO Standard&quot;</span>
                <span class="k">elif</span> <span class="s2">&quot;fda&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="n">standard</span> <span class="o">=</span> <span class="s2">&quot;FDA Regulation&quot;</span>
                <span class="k">elif</span> <span class="s2">&quot;mdr&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="n">standard</span> <span class="o">=</span> <span class="s2">&quot;MDR Regulation&quot;</span>

                <span class="n">applicable</span> <span class="o">=</span> <span class="s2">&quot;yes&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="s2">&quot;applicable&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="n">justification</span> <span class="o">=</span> <span class="s2">&quot;LLM response format not structured&quot;</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to parse LLM response for section </span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Raw response was: </span><span class="si">{</span><span class="n">response</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Fallback parsing</span>
            <span class="n">applicable</span> <span class="o">=</span> <span class="s2">&quot;yes&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">justification</span> <span class="o">=</span> <span class="s2">&quot;Response parsing failed&quot;</span>
            <span class="n">standard</span> <span class="o">=</span> <span class="s2">&quot;Unknown&quot;</span>

        <span class="c1"># Ensure we have valid values</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">standard</span> <span class="ow">or</span> <span class="n">standard</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">standard</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">justification</span> <span class="ow">or</span> <span class="n">justification</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">justification</span> <span class="o">=</span> <span class="s2">&quot;Not specified&quot;</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Section </span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2"> - Standard: </span><span class="si">{</span><span class="n">standard</span><span class="si">}</span><span class="s2">, Applicable: </span><span class="si">{</span><span class="n">applicable</span><span class="si">}</span><span class="s2">, Justification: </span><span class="si">{</span><span class="n">justification</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;standard&quot;</span><span class="p">:</span> <span class="n">standard</span><span class="p">,</span>
            <span class="s2">&quot;is_applicable&quot;</span><span class="p">:</span> <span class="n">applicable</span><span class="p">,</span>
            <span class="s2">&quot;requirement_type&quot;</span><span class="p">:</span> <span class="n">section</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;requirement_type&quot;</span><span class="p">,</span> <span class="s2">&quot;Unknown&quot;</span><span class="p">),</span>
            <span class="s2">&quot;requirement_justification&quot;</span><span class="p">:</span> <span class="n">justification</span><span class="p">,</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span> <span class="k">if</span> <span class="n">applicable</span> <span class="k">else</span> <span class="s2">&quot;skipped&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># Add result to session manager if provided</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">regulatory.app.core.state</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_session_manager</span>
            <span class="n">session_mgr</span> <span class="o">=</span> <span class="n">get_session_manager</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">session_mgr</span> <span class="ow">and</span> <span class="n">session_id</span><span class="p">:</span>
                <span class="c1"># Create section result payload</span>
                <span class="n">section_result</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;section_id&quot;</span><span class="p">:</span> <span class="n">section</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;section_</span><span class="si">{</span><span class="n">title</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                    <span class="s2">&quot;section_title&quot;</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span>
                    <span class="s2">&quot;group_name&quot;</span><span class="p">:</span> <span class="n">group_name</span><span class="p">,</span>
                    <span class="s2">&quot;component_name&quot;</span><span class="p">:</span> <span class="n">component_name</span><span class="p">,</span>
                    <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">,</span>
                    <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span>
                <span class="p">}</span>

                <span class="c1"># Use proper nested dictionary structure (not dot notation)</span>
                <span class="n">update_payload</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;gspr_section_results&quot;</span><span class="p">:</span> <span class="p">{</span><span class="n">section_result</span><span class="p">[</span><span class="s2">&quot;section_id&quot;</span><span class="p">]:</span> <span class="n">section_result</span><span class="p">}}</span>

                <span class="n">success</span> <span class="o">=</span> <span class="n">session_mgr</span><span class="o">.</span><span class="n">update_nested</span><span class="p">(</span><span class="n">session_id</span><span class="p">,</span> <span class="n">update_payload</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚úÖ Added GSPR result for section &#39;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">&#39; to session </span><span class="si">{</span><span class="n">session_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚ö†Ô∏è Failed to add GSPR result for section &#39;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">&#39; to session </span><span class="si">{</span><span class="n">session_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to update session manager: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generated reasoning for &#39;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">&#39; ‚Üí </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;standard&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">determine_temperature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_title</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ask the LLM to self-select an appropriate temperature between 0.1‚Äì0.9.</span>
<span class="sd">        This helps the system decide how deterministic or creative to be.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="n">get_temperature_prompt</span><span class="p">()</span>

        <span class="n">structured_llm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">small_llm</span><span class="o">.</span><span class="n">with_structured_output</span><span class="p">(</span><span class="n">TemperatureModel</span><span class="p">)</span>

        <span class="n">temperature_chain</span> <span class="o">=</span> <span class="n">prompt</span> <span class="o">|</span> <span class="n">structured_llm</span>

        <span class="n">inputs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;context_summary&quot;</span><span class="p">:</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="s2">&quot;N/A&quot;</span><span class="p">),</span>
            <span class="s2">&quot;node_title&quot;</span><span class="p">:</span> <span class="n">node_title</span> <span class="ow">or</span> <span class="s2">&quot;Unnamed Node&quot;</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span><span class="p">:</span> <span class="n">TemperatureModel</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">TemperatureModel</span><span class="p">,</span> <span class="k">await</span> <span class="n">temperature_chain</span><span class="o">.</span><span class="n">ainvoke</span><span class="p">(</span><span class="n">inputs</span><span class="p">))</span>
            <span class="n">temp_value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">temperature</span><span class="p">)</span>
            <span class="n">temp_value</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">temp_value</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Structured LLM chose adaptive temperature: </span><span class="si">{</span><span class="n">temp_value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">temp_value</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Structured temperature selection failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mf">0.3</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="core.chains.gspr_chain.GSPRChain.build_context" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">build_context</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">base_context</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Builds or enriches session context using regulatory reasoning.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>core/chains/gspr_chain.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">build_context</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">base_context</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">temperature</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Builds or enriches session context using regulatory reasoning.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">context</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">base_context</span> <span class="ow">or</span> <span class="p">{})</span>

    <span class="n">prompt</span> <span class="o">=</span> <span class="n">get_context_prompt</span><span class="p">()</span>
    <span class="n">formatted_prompt</span> <span class="o">=</span> <span class="n">prompt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">context_json</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>

    <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_llm_call</span><span class="p">(</span>
        <span class="n">formatted_prompt</span><span class="p">,</span>
        <span class="n">structured_schema</span><span class="o">=</span><span class="n">ContextSummaryModel</span><span class="p">,</span>
        <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># If response is a Pydantic model instance, use its .model_dump() method</span>
    <span class="n">context</span><span class="p">[</span><span class="s2">&quot;summary&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Context successfully built via model </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">context</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="core.chains.gspr_chain.GSPRChain.determine_temperature" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">determine_temperature</span><span class="p">(</span><span class="n">node_title</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Ask the LLM to self-select an appropriate temperature between 0.1‚Äì0.9.
This helps the system decide how deterministic or creative to be.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>core/chains/gspr_chain.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">determine_temperature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_title</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Ask the LLM to self-select an appropriate temperature between 0.1‚Äì0.9.</span>
<span class="sd">    This helps the system decide how deterministic or creative to be.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">prompt</span> <span class="o">=</span> <span class="n">get_temperature_prompt</span><span class="p">()</span>

    <span class="n">structured_llm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">small_llm</span><span class="o">.</span><span class="n">with_structured_output</span><span class="p">(</span><span class="n">TemperatureModel</span><span class="p">)</span>

    <span class="n">temperature_chain</span> <span class="o">=</span> <span class="n">prompt</span> <span class="o">|</span> <span class="n">structured_llm</span>

    <span class="n">inputs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;context_summary&quot;</span><span class="p">:</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="s2">&quot;N/A&quot;</span><span class="p">),</span>
        <span class="s2">&quot;node_title&quot;</span><span class="p">:</span> <span class="n">node_title</span> <span class="ow">or</span> <span class="s2">&quot;Unnamed Node&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">result</span><span class="p">:</span> <span class="n">TemperatureModel</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">TemperatureModel</span><span class="p">,</span> <span class="k">await</span> <span class="n">temperature_chain</span><span class="o">.</span><span class="n">ainvoke</span><span class="p">(</span><span class="n">inputs</span><span class="p">))</span>
        <span class="n">temp_value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">temperature</span><span class="p">)</span>
        <span class="n">temp_value</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">temp_value</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Structured LLM chose adaptive temperature: </span><span class="si">{</span><span class="n">temp_value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">temp_value</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Structured temperature selection failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mf">0.3</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="core.chains.gspr_chain.GSPRChain.generate_section" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">generate_section</span><span class="p">(</span><span class="n">session_id</span><span class="p">,</span> <span class="n">section</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">component_name</span><span class="p">,</span> <span class="n">group_name</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Generates the reasoning or compliance mapping for a single section.
Returns: structured dict with standard, applicability, and justification.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>core/chains/gspr_chain.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">generate_section</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">session_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">section</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">context</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">component_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">group_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">temperature</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.4</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates the reasoning or compliance mapping for a single section.</span>
<span class="sd">    Returns: structured dict with standard, applicability, and justification.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;Unnamed Section&quot;</span><span class="p">)</span>
    <span class="n">body</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">summary</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="n">prompt</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;You are an expert in regulatory compliance.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;Section Title: </span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;Group: </span><span class="si">{</span><span class="n">group_name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;Component: </span><span class="si">{</span><span class="n">component_name</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;Session Summary:</span><span class="se">\n</span><span class="si">{</span><span class="n">summary</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;Section Text:</span><span class="se">\n</span><span class="si">{</span><span class="n">body</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;CRITICAL: You MUST respond in the exact format below. Do not include explanations or additional text.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;Tasks:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;1. Identify ONE most relevant regulatory standard (ISO/FDA/MDR)</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;2. Decide if this requirement is applicable (yes/no)</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;3. Provide a brief justification (maximum 8 words)</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;REQUIRED FORMAT (copy exactly):</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;STANDARD: [standard name only]</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;APPLICABLE: [yes or no]</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;JUSTIFICATION: [brief reason]</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;Good Examples:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;STANDARD: ISO 13485</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;APPLICABLE: yes</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;JUSTIFICATION: Supplier responsibility per QMS procedure</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;STANDARD: FDA 21 CFR 820</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;APPLICABLE: no</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;JUSTIFICATION: Not relevant for device type</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;STANDARD: None</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;APPLICABLE: no</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;JUSTIFICATION: Outside regulatory scope</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="sa">f</span><span class="s2">&quot;Respond ONLY in the required format above.&quot;</span>
    <span class="p">)</span>

    <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_llm_call</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">)</span>

    <span class="c1"># Parse the structured response</span>
    <span class="n">standard</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span>
    <span class="n">applicable</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">justification</span> <span class="o">=</span> <span class="s2">&quot;Not specified&quot;</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Raw LLM response for section </span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">response</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;STANDARD:&quot;</span><span class="p">):</span>
                <span class="n">standard</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;STANDARD:&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">standard</span><span class="p">:</span>
                    <span class="n">standard</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span>
            <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;APPLICABLE:&quot;</span><span class="p">):</span>
                <span class="n">applicable</span> <span class="o">=</span> <span class="s2">&quot;yes&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;JUSTIFICATION:&quot;</span><span class="p">):</span>
                <span class="n">justification</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;JUSTIFICATION:&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">justification</span><span class="p">:</span>
                    <span class="n">justification</span> <span class="o">=</span> <span class="s2">&quot;Not specified&quot;</span>

        <span class="c1"># Validate parsing results</span>
        <span class="k">if</span> <span class="n">standard</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span> <span class="ow">and</span> <span class="n">justification</span> <span class="o">==</span> <span class="s2">&quot;Not specified&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">applicable</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;LLM response parsing may have failed for section </span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">. Using fallback.&quot;</span><span class="p">)</span>
            <span class="c1"># Fallback parsing for unstructured response</span>
            <span class="k">if</span> <span class="s2">&quot;iso&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">standard</span> <span class="o">=</span> <span class="s2">&quot;ISO Standard&quot;</span>
            <span class="k">elif</span> <span class="s2">&quot;fda&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">standard</span> <span class="o">=</span> <span class="s2">&quot;FDA Regulation&quot;</span>
            <span class="k">elif</span> <span class="s2">&quot;mdr&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">standard</span> <span class="o">=</span> <span class="s2">&quot;MDR Regulation&quot;</span>

            <span class="n">applicable</span> <span class="o">=</span> <span class="s2">&quot;yes&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="s2">&quot;applicable&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">justification</span> <span class="o">=</span> <span class="s2">&quot;LLM response format not structured&quot;</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to parse LLM response for section </span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Raw response was: </span><span class="si">{</span><span class="n">response</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Fallback parsing</span>
        <span class="n">applicable</span> <span class="o">=</span> <span class="s2">&quot;yes&quot;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">justification</span> <span class="o">=</span> <span class="s2">&quot;Response parsing failed&quot;</span>
        <span class="n">standard</span> <span class="o">=</span> <span class="s2">&quot;Unknown&quot;</span>

    <span class="c1"># Ensure we have valid values</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">standard</span> <span class="ow">or</span> <span class="n">standard</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">standard</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">justification</span> <span class="ow">or</span> <span class="n">justification</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">justification</span> <span class="o">=</span> <span class="s2">&quot;Not specified&quot;</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Section </span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2"> - Standard: </span><span class="si">{</span><span class="n">standard</span><span class="si">}</span><span class="s2">, Applicable: </span><span class="si">{</span><span class="n">applicable</span><span class="si">}</span><span class="s2">, Justification: </span><span class="si">{</span><span class="n">justification</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;standard&quot;</span><span class="p">:</span> <span class="n">standard</span><span class="p">,</span>
        <span class="s2">&quot;is_applicable&quot;</span><span class="p">:</span> <span class="n">applicable</span><span class="p">,</span>
        <span class="s2">&quot;requirement_type&quot;</span><span class="p">:</span> <span class="n">section</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;requirement_type&quot;</span><span class="p">,</span> <span class="s2">&quot;Unknown&quot;</span><span class="p">),</span>
        <span class="s2">&quot;requirement_justification&quot;</span><span class="p">:</span> <span class="n">justification</span><span class="p">,</span>
        <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span> <span class="k">if</span> <span class="n">applicable</span> <span class="k">else</span> <span class="s2">&quot;skipped&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1"># Add result to session manager if provided</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">regulatory.app.core.state</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_session_manager</span>
        <span class="n">session_mgr</span> <span class="o">=</span> <span class="n">get_session_manager</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">session_mgr</span> <span class="ow">and</span> <span class="n">session_id</span><span class="p">:</span>
            <span class="c1"># Create section result payload</span>
            <span class="n">section_result</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;section_id&quot;</span><span class="p">:</span> <span class="n">section</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;section_</span><span class="si">{</span><span class="n">title</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                <span class="s2">&quot;section_title&quot;</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span>
                <span class="s2">&quot;group_name&quot;</span><span class="p">:</span> <span class="n">group_name</span><span class="p">,</span>
                <span class="s2">&quot;component_name&quot;</span><span class="p">:</span> <span class="n">component_name</span><span class="p">,</span>
                <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">,</span>
                <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span>
            <span class="p">}</span>

            <span class="c1"># Use proper nested dictionary structure (not dot notation)</span>
            <span class="n">update_payload</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;gspr_section_results&quot;</span><span class="p">:</span> <span class="p">{</span><span class="n">section_result</span><span class="p">[</span><span class="s2">&quot;section_id&quot;</span><span class="p">]:</span> <span class="n">section_result</span><span class="p">}}</span>

            <span class="n">success</span> <span class="o">=</span> <span class="n">session_mgr</span><span class="o">.</span><span class="n">update_nested</span><span class="p">(</span><span class="n">session_id</span><span class="p">,</span> <span class="n">update_payload</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚úÖ Added GSPR result for section &#39;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">&#39; to session </span><span class="si">{</span><span class="n">session_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚ö†Ô∏è Failed to add GSPR result for section &#39;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">&#39; to session </span><span class="si">{</span><span class="n">session_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to update session manager: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generated reasoning for &#39;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">&#39; ‚Üí </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;standard&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="core.chains.gspr_chain.GSPRChain.group_sections" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">group_sections</span><span class="p">(</span><span class="n">sections</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">component_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">max_concurrency</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <p>Groups sections semantically using GPT structured output with DEEP ANALYSIS.</p>
<p>Performs comprehensive regulatory analysis by:
- Analyzing both titles AND full descriptions
- Using higher temperature for thoughtful reasoning
- Smaller batch sizes for focused analysis
- Single best-fit group assignment per section
- Detailed timing and assignment statistics</p>
<p>Returns: [{"group": str, "sections": [...] }] with single assignment per section</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>core/chains/gspr_chain.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">group_sections</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">sections</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
    <span class="n">context</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">component_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">temperature</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.6</span><span class="p">,</span>  <span class="c1"># Higher temperature for more thoughtful analysis</span>
    <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">25</span><span class="p">,</span>  <span class="c1"># Smaller batches for deeper focus</span>
    <span class="n">max_concurrency</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>  <span class="c1"># Reduced concurrency for more careful processing</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Groups sections semantically using GPT structured output with DEEP ANALYSIS.</span>

<span class="sd">    Performs comprehensive regulatory analysis by:</span>
<span class="sd">    - Analyzing both titles AND full descriptions</span>
<span class="sd">    - Using higher temperature for thoughtful reasoning</span>
<span class="sd">    - Smaller batch sizes for focused analysis</span>
<span class="sd">    - Single best-fit group assignment per section</span>
<span class="sd">    - Detailed timing and assignment statistics</span>

<span class="sd">    Returns: [{&quot;group&quot;: str, &quot;sections&quot;: [...] }] with single assignment per section</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># ------------------------------------------------------------</span>
    <span class="c1"># Split sections into manageable batches</span>
    <span class="c1"># ------------------------------------------------------------</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&quot;</span><span class="p">)</span>
    <span class="n">total_sections</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sections</span><span class="p">)</span>

    <span class="n">batches</span> <span class="o">=</span> <span class="p">[</span><span class="n">sections</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">total_sections</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="n">total_sections</span><span class="si">}</span><span class="s2"> sections in </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">batches</span><span class="p">)</span><span class="si">}</span><span class="s2"> batches (batch size=</span><span class="si">{</span><span class="n">batch_size</span><span class="si">}</span><span class="s2">, max_concurrency=</span><span class="si">{</span><span class="n">max_concurrency</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">)</span>

    <span class="c1"># ------------------------------------------------------------</span>
    <span class="c1"># Prepare title index for mapping back</span>
    <span class="c1"># ------------------------------------------------------------</span>
    <span class="n">title_index</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]:</span> <span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sections</span><span class="p">}</span>
    <span class="n">merged_groups</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">semaphore</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Semaphore</span><span class="p">(</span><span class="n">max_concurrency</span><span class="p">)</span>

    <span class="c1"># ------------------------------------------------------------</span>
    <span class="c1"># Helper to process a single batch</span>
    <span class="c1"># ------------------------------------------------------------</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_process_batch</span><span class="p">(</span><span class="n">batch</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">batch_num</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">component_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GroupingModel</span><span class="p">:</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">semaphore</span><span class="p">:</span>
            <span class="c1"># Create detailed sections with titles AND descriptions for analysis</span>
            <span class="n">sections_with_descriptions</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">section</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">title</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;Untitled Section&quot;</span><span class="p">)</span>
                <span class="n">description</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="s2">&quot;No description available&quot;</span><span class="p">)</span>
                <span class="c1"># Truncate very long descriptions to avoid token limits</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">description</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">:</span>
                    <span class="n">description</span> <span class="o">=</span> <span class="n">description</span><span class="p">[:</span><span class="mi">497</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;...&quot;</span>
                <span class="n">sections_with_descriptions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. TITLE: </span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="se">\n</span><span class="s2">   DESCRIPTION: </span><span class="si">{</span><span class="n">description</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">sections_text</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sections_with_descriptions</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Batch </span><span class="si">{</span><span class="n">batch_num</span><span class="si">}</span><span class="s2">] Deep analysis of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span><span class="si">}</span><span class="s2"> sectizons with full descriptions.&quot;</span><span class="p">)</span>

            <span class="n">prompt</span> <span class="o">=</span> <span class="n">get_grouping_prompt</span><span class="p">()</span>
            <span class="n">formatted_prompt</span> <span class="o">=</span> <span class="n">prompt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">context_summary</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;summary&quot;</span><span class="p">,</span> <span class="s2">&quot;N/A&quot;</span><span class="p">),</span>
                <span class="n">sections_with_descriptions</span><span class="o">=</span><span class="n">sections_text</span><span class="p">,</span>
                <span class="n">component_name</span><span class="o">=</span><span class="n">component_name</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Structured JSON call per batch with timing</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>

            <span class="n">response</span><span class="p">:</span> <span class="n">GroupingModel</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_llm_call</span><span class="p">(</span>
                <span class="n">formatted_prompt</span><span class="p">,</span>
                <span class="n">structured_schema</span><span class="o">=</span><span class="n">GroupingModel</span><span class="p">,</span>
                <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">processing_time</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

            <span class="c1"># Calculate assignment statistics for this batch</span>
            <span class="n">total_assignments</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">sections</span><span class="p">)</span> <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">groups</span><span class="p">)</span>
            <span class="n">batch_sections</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Batch </span><span class="si">{</span><span class="n">batch_num</span><span class="si">}</span><span class="s2">] Deep analysis completed in </span><span class="si">{</span><span class="n">processing_time</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Batch </span><span class="si">{</span><span class="n">batch_num</span><span class="si">}</span><span class="s2">] Single assignments: </span><span class="si">{</span><span class="n">total_assignments</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">batch_sections</span><span class="si">}</span><span class="s2"> sections assigned&quot;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">response</span>

    <span class="c1"># ------------------------------------------------------------</span>
    <span class="c1"># 4Ô∏è‚É£ Run all batches in parallel</span>
    <span class="c1"># ------------------------------------------------------------</span>
    <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">_process_batch</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">component_name</span> <span class="ow">or</span> <span class="s2">&quot;unknown&quot;</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">batches</span><span class="p">)]</span>
    <span class="n">responses</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;All </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">responses</span><span class="p">)</span><span class="si">}</span><span class="s2"> batches completed.&quot;</span><span class="p">)</span>

    <span class="c1"># ------------------------------------------------------------</span>
    <span class="c1"># 5Ô∏è‚É£ Merge grouped results from all batches (SINGLE ASSIGNMENT ONLY)</span>
    <span class="c1"># ------------------------------------------------------------</span>
    <span class="k">for</span> <span class="n">batch_idx</span><span class="p">,</span> <span class="n">response</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">responses</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">batch_mapped_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">groups</span><span class="p">:</span>
            <span class="n">mapped_sections</span> <span class="o">=</span> <span class="p">[</span><span class="n">title_index</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">group</span><span class="o">.</span><span class="n">sections</span> <span class="k">if</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">title_index</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">group</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">merged_groups</span><span class="p">:</span>
                <span class="n">merged_groups</span><span class="p">[</span><span class="n">group</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">merged_groups</span><span class="p">[</span><span class="n">group</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">mapped_sections</span><span class="p">)</span>
            <span class="n">batch_mapped_count</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mapped_sections</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Batch </span><span class="si">{</span><span class="n">batch_idx</span><span class="si">}</span><span class="s2">] Added </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">groups</span><span class="p">)</span><span class="si">}</span><span class="s2"> groups with </span><span class="si">{</span><span class="n">batch_mapped_count</span><span class="si">}</span><span class="s2"> sections.&quot;</span><span class="p">)</span>

    <span class="c1"># ------------------------------------------------------------</span>
    <span class="c1"># 6Ô∏è‚É£ Handle any missing titles (fallback for single assignments)</span>
    <span class="c1"># ------------------------------------------------------------</span>
    <span class="n">all_mapped_titles</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">merged_groups</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">g</span><span class="p">}</span>
    <span class="n">missing_sections</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sections</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">all_mapped_titles</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">missing_sections</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">missing_sections</span><span class="p">)</span><span class="si">}</span><span class="s2"> sections were unassigned ‚Äî adding to &#39;Miscellaneous&#39;.&quot;</span><span class="p">)</span>
        <span class="n">merged_groups</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;Miscellaneous&quot;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">missing_sections</span><span class="p">)</span>

    <span class="c1"># ------------------------------------------------------------</span>
    <span class="c1"># 7Ô∏è‚É£ Final structured result (single assignment per section)</span>
    <span class="c1"># ------------------------------------------------------------</span>
    <span class="n">grouped_sections</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;group&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="s2">&quot;sections&quot;</span><span class="p">:</span> <span class="n">secs</span><span class="p">}</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">secs</span> <span class="ow">in</span> <span class="n">merged_groups</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>

    <span class="c1"># Calculate statistics for single assignments</span>
    <span class="n">total_assigned</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">secs</span><span class="p">)</span> <span class="k">for</span> <span class="n">secs</span> <span class="ow">in</span> <span class="n">merged_groups</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="n">total_sections</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sections</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;‚úÖ Grouped </span><span class="si">{</span><span class="n">total_sections</span><span class="si">}</span><span class="s2"> sections into </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">grouped_sections</span><span class="p">)</span><span class="si">}</span><span class="s2"> groups.&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;üìä Assignment: </span><span class="si">{</span><span class="n">total_assigned</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">total_sections</span><span class="si">}</span><span class="s2"> sections assigned (single assignment per section).&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">grouped_sections</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div><hr />
<h2 id="gspr-generator-chain-build-gspr-documentation">üèóÔ∏è GSPR Generator Chain ‚Äî Build GSPR Documentation</h2>
<p>Automatically generates structured <strong>GSPR compliance documentation</strong>, mapping requirements to device characteristics.<br />
Ensures consistency, traceability, and audit-ready formatting.</p>


<div class="doc doc-object doc-module">



<a id="core.chains.gspr_generator_chain"></a>
    <div class="doc doc-contents first">

        <p>This module builds and initializes the GSPR (General Safety and Performance
Requirements) generator chain. It prepares the PromptTemplate, loads the
LLM backend, and wraps it with a structured output model to generate
high-quality, schema-validated GSPR entries.</p>
<h3 id="core.chains.gspr_generator_chain--workflow">Workflow:</h3>
<ol>
<li>Create a PromptTemplate based on the GSPR generator prompt string.</li>
<li>Load the configured vLLM model using the internal LLM provider.</li>
<li>Wrap the model with structured output using <code>GSPRGeneratorModel</code>.</li>
<li>Construct a runnable chain: prompt ‚Üí LLM ‚Üí structured output.</li>
</ol>
<p>This chain is used by the system to produce consistent, validated,
and regulatory-aligned GSPR entries for varied medical devices.</p>










  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h2 id="core.chains.gspr_generator_chain.prompt" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">prompt</span> <span class="o">=</span> <span class="n">PromptTemplate</span><span class="p">(</span><span class="n">template</span><span class="o">=</span><span class="n">GSPR_GENERATOR_PROMPT</span><span class="p">,</span> <span class="n">input_variables</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;medical_device&#39;</span><span class="p">,</span> <span class="s1">&#39;material_type&#39;</span><span class="p">,</span> <span class="s1">&#39;device_type&#39;</span><span class="p">,</span> <span class="s1">&#39;intended_purpose&#39;</span><span class="p">,</span> <span class="s1">&#39;intended_users&#39;</span><span class="p">,</span> <span class="s1">&#39;risk_classifications&#39;</span><span class="p">,</span> <span class="s1">&#39;component&#39;</span><span class="p">,</span> <span class="s1">&#39;gspr&#39;</span><span class="p">])</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">



<details class="prompttemplate" open>
  <summary>PromptTemplate</summary>
  <p>Defines the template used by the GSPR generator. It inserts dynamic fields
such as the medical device type, intended purpose, component details, and
specific GSPR requirements. This template ensures all contextual inputs are
passed into the LLM in a structured format.</p>
</details>
    </div>

</div>




<div class="doc doc-object doc-function">


<h2 id="core.chains.gspr_generator_chain.get_gspr_generator_chain" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_gspr_generator_chain</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Get GSPR generator chain with current model selection.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>core/chains/gspr_generator_chain.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_gspr_generator_chain</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get GSPR generator chain with current model selection.&quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating GSPR generator chain with current model...&quot;</span><span class="p">)</span>
    <span class="n">gspr_generator_llm</span> <span class="o">=</span> <span class="n">get_gspr_generator_llm</span><span class="p">()</span>
    <span class="n">chain</span> <span class="o">=</span> <span class="n">prompt</span> <span class="o">|</span> <span class="n">gspr_generator_llm</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    GSPR Generator Chain:</span>
<span class="sd">        Creates the final chain by piping:</span>
<span class="sd">            PromptTemplate ‚Üí LLM ‚Üí Structured Output.</span>
<span class="sd">        This runnable chain is used throughout the application to generate</span>
<span class="sd">        GSPR-compliant entries with deterministic structure and high-quality</span>
<span class="sd">        regulatory reasoning.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;GSPR generator chain initialized.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">chain</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="core.chains.gspr_generator_chain.get_gspr_generator_llm" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_gspr_generator_llm</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Get LLM instance with current model selection for runtime switching.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>core/chains/gspr_generator_chain.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_gspr_generator_llm</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get LLM instance with current model selection for runtime switching.&quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating GSPR generator LLM instance with current model selection...&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">llm</span> <span class="o">=</span> <span class="n">get_vllm_llm</span><span class="p">()</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        LLM Loader:</span>
<span class="sd">            Loads the vLLM backend configured for regulatory text generation.</span>
<span class="sd">            The model is optimized for structured compliance reasoning and </span>
<span class="sd">            supports high-volume inference.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;LLM initialized successfully.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">llm</span><span class="o">.</span><span class="n">with_structured_output</span><span class="p">(</span><span class="n">GSPRGeneratorModel</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to initialize LLM - </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><hr />
<h2 id="guard-chain-apply-rule-based-validations">üö® Guard Chain ‚Äî Apply Rule-Based Validations</h2>
<p>Implements safety, logic, and regulatory guards on user inputs and generated outputs.<br />
Prevents invalid data, enforces constraints, and ensures workflow integrity.</p>


<div class="doc doc-object doc-module">



<a id="core.chains.guard_chain"></a>
    <div class="doc doc-contents first">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h2 id="core.chains.guard_chain.get_guard_chain" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_guard_chain</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Get guard chain with current model selection.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>core/chains/guard_chain.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_guard_chain</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get guard chain with current model selection.&quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating guard chain with current model...&quot;</span><span class="p">)</span>
    <span class="n">llm</span> <span class="o">=</span> <span class="n">get_guard_llm</span><span class="p">()</span>
    <span class="n">chain</span> <span class="o">=</span> <span class="n">prompt</span> <span class="o">|</span> <span class="n">llm</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Guard chain initialized successfully.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">chain</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="core.chains.guard_chain.get_guard_llm" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_guard_llm</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Get LLM instance with current model selection for runtime switching.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>core/chains/guard_chain.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_guard_llm</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get LLM instance with current model selection for runtime switching.&quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating guard LLM instance with current model selection...&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">llm</span> <span class="o">=</span> <span class="n">get_vllm_llm</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;LLM initialized successfully.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">llm</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to initialize LLM - </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><hr />
<h2 id="intended-user-chain-identify-expected-user-profiles">üë• Intended User Chain ‚Äî Identify Expected User Profiles</h2>
<p>Analyzes device context to determine <strong>intended users</strong>, such as clinicians, technicians, or patients.<br />
Ensures user-centric design alignment with regulatory assessment standards .</p>


<div class="doc doc-object doc-module">



<a id="core.chains.intended_user_chain"></a>
    <div class="doc doc-contents first">










  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h2 id="core.chains.intended_user_chain.prompt" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">prompt</span> <span class="o">=</span> <span class="n">PromptTemplate</span><span class="p">(</span><span class="n">template</span><span class="o">=</span><span class="n">INTENDED_USER_PROMPT</span><span class="p">,</span> <span class="n">input_variables</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;medical_device&#39;</span><span class="p">,</span> <span class="s1">&#39;device_type&#39;</span><span class="p">,</span> <span class="s1">&#39;intended_purpose&#39;</span><span class="p">,</span> <span class="s1">&#39;material_type&#39;</span><span class="p">,</span> <span class="s1">&#39;components&#39;</span><span class="p">,</span> <span class="s1">&#39;risk_classification&#39;</span><span class="p">])</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">

        <p>Retrieve the intended user LLM instance.</p>
<p>This function initializes and returns a language model (LLM) instance configured
for the intended user chain. The LLM is structured to generate outputs based on
device type, intended purpose, and other inputs.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>LLM</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A language model instance configured with the IntendedUserModel.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="Exception">Exception</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the LLM initialization fails.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <p>llm = get_intended_user_llm()
response = llm.invoke({"device_type": "Sensor", "intended_purpose": "Monitoring"})</p>
</details>
    </div>

</div>




<div class="doc doc-object doc-function">


<h2 id="core.chains.intended_user_chain.get_intended_user_chain" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_intended_user_chain</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Get intended user chain with current model selection.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>core/chains/intended_user_chain.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_intended_user_chain</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get intended user chain with current model selection.&quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating intended user chain with current model...&quot;</span><span class="p">)</span>
    <span class="n">intended_user_llm</span> <span class="o">=</span> <span class="n">get_intended_user_llm</span><span class="p">()</span>
    <span class="n">chain</span> <span class="o">=</span> <span class="n">prompt</span> <span class="o">|</span> <span class="n">intended_user_llm</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Intended user chain created successfully.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">chain</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="core.chains.intended_user_chain.get_intended_user_llm" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_intended_user_llm</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Get LLM instance with current model selection for runtime switching.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>core/chains/intended_user_chain.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_intended_user_llm</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get LLM instance with current model selection for runtime switching.&quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating intended user LLM instance with current model selection...&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">llm</span> <span class="o">=</span> <span class="n">get_vllm_llm</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;LLM initialized successfully.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">llm</span><span class="o">.</span><span class="n">with_structured_output</span><span class="p">(</span><span class="n">IntendedUserModel</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Failed to initialize LLM: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;LLM initialization exception message: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><hr />
<h2 id="risk-classification-chain-determine-device-risk-class">üß™ Risk Classification Chain ‚Äî Determine Device Risk Class</h2>
<p>Evaluates device properties to assign the correct <strong>risk class</strong> under GSPR frameworks.<br />
Supports consistent classification logic required for regulatory pathways.</p>


<div class="doc doc-object doc-module">



<a id="core.chains.risk_classification_chain"></a>
    <div class="doc doc-contents first">










  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h2 id="core.chains.risk_classification_chain.get_llm_for_region" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_llm_for_region</span><span class="p">(</span><span class="n">region</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Return appropriate LLM based on region.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>core/chains/risk_classification_chain.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_llm_for_region</span><span class="p">(</span><span class="n">region</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return appropriate LLM based on region.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">region</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;eu&quot;</span><span class="p">,</span> <span class="s2">&quot;india&quot;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">get_chatmdr_llm</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">region</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;us&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">get_chatfda_llm</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">get_vllm_llm</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="core.chains.risk_classification_chain.get_risk_classification_chain" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_risk_classification_chain</span><span class="p">(</span><span class="n">region</span><span class="o">=</span><span class="s1">&#39;usa&#39;</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Get risk classification chain with current model selection.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>core/chains/risk_classification_chain.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span>
<span class="normal">97</span>
<span class="normal">98</span>
<span class="normal">99</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_risk_classification_chain</span><span class="p">(</span><span class="n">region</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;usa&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get risk classification chain with current model selection.&quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating risk classification chain with current model...&quot;</span><span class="p">)</span>
    <span class="n">risk_classification_llm</span> <span class="o">=</span> <span class="n">get_risk_classification_llm</span><span class="p">(</span><span class="n">region</span><span class="p">)</span>
    <span class="n">chain</span> <span class="o">=</span> <span class="n">prompt</span> <span class="o">|</span> <span class="n">risk_classification_llm</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Risk classification chain created successfully.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">chain</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="core.chains.risk_classification_chain.get_risk_classification_llm" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_risk_classification_llm</span><span class="p">(</span><span class="n">region</span><span class="o">=</span><span class="s1">&#39;usa&#39;</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Get LLM instance with current model selection for runtime switching.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>core/chains/risk_classification_chain.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_risk_classification_llm</span><span class="p">(</span><span class="n">region</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;usa&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get LLM instance with current model selection for runtime switching.&quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating risk classification LLM instance with current model selection for region &#39;</span><span class="si">{</span><span class="n">region</span><span class="si">}</span><span class="s2">&#39;...&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">llm</span> <span class="o">=</span> <span class="n">get_llm_for_region</span><span class="p">(</span><span class="n">region</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;LLM for region &#39;</span><span class="si">{</span><span class="n">region</span><span class="si">}</span><span class="s2">&#39; initialized successfully.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">llm</span><span class="o">.</span><span class="n">with_structured_output</span><span class="p">(</span><span class="n">RiskClassificationModel</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;json_mode&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Failed to initialize LLM&quot;</span><span class="p">)</span>
        <span class="k">raise</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js"></script>
        <script src="../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
